<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>INEX Systems & Designs — Agreement</title>
  <link rel="icon" href="vite.ico" />
  
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Cinzel:wght@600;700&family=Great+Vibes&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- EmailJS for sending contract notifications -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <!-- Firebase Client SDK (public) for login-gated access -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <!-- Local Firebase configuration for development -->
  <script src="firebase-config.js"></script>
  <!-- Fallback Firebase config if external file fails -->
  <script>
    // Fallback Firebase configuration if firebase-config.js is not available
    if (!window.FIREBASE_CONFIG) {
      window.FIREBASE_CONFIG = {
        apiKey: "AIzaSyBW4HaQtl9Xce82dDByp_k0I1wVybgbCFQ",
        authDomain: "inex-a4b30.firebaseapp.com",
        projectId: "inex-a4b30",
        storageBucket: "inex-a4b30.firebasestorage.app",
        messagingSenderId: "111262904587",
        appId: "1:111262904587:web:7368dc9a07c8bdc44db20e",
        measurementId: "G-CL6M00YQJH"
      };
      console.log('Using fallback Firebase config from HTML');
    }
  </script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas for high-fidelity HTML->PDF rendering -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    :root {
      --ink: #0f0f10;
      --muted: #6b7280;
      --panel: #0b0b0c;
      --panel-2: #121214;
      --border: #26272b;
      --accent: #FFB200;
      --brand: #A62E3F; /* INEX maroon */
      --radius: 14px;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --white: #ffffff;
    }
    html, body { height: 100%; }
    body {
      margin: 0; color: var(--white); background: radial-gradient(1200px 600px at 15% -10%, rgba(166,46,63,.08), transparent 60%),
                 radial-gradient(1200px 600px at 85% 110%, rgba(255,178,0,.08), transparent 60%),
                 #000; font: 14px/1.65 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .wrap { max-width: 1080px; margin: 36px auto; padding: 0 18px; }
    .doc { background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)); border: 1px solid var(--border); border-radius: 18px; box-shadow: var(--shadow); overflow: hidden; }
    .head {
      display: grid; grid-template-columns: auto 1fr auto; gap: 16px; align-items: center;
      background: linear-gradient(135deg, rgba(166,46,63,.25), rgba(10,10,10,1)); padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    .brand-logos { display: flex; align-items: center; gap: 14px; }
    .brand-logos img { height: 36px; width: auto; filter: drop-shadow(0 6px 18px rgba(0,0,0,.6)); }
    .title h1 { margin: 0; font: 800 18px/1.25 Inter, sans-serif; letter-spacing: .2px; }
    .title .sub { margin-top: 4px; font-size: 12px; color: #d1d5db; }
    .badge { background: rgba(255,178,0,.1); color: var(--accent); border: 1px solid rgba(255,178,0,.35); padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: 12px; }

    .section { padding: 20px; background: var(--panel); border-bottom: 1px solid var(--border); }
    .section + .section { background: var(--panel-2); }
    h2 { margin: .2rem 0 .6rem 0; font: 700 16px/1.35 Inter; letter-spacing:.2px; color: #f9fafb }
    h3 { margin: 1rem 0 .35rem 0; font: 700 14px/1.35 Inter; color: #e5e7eb }
    p { margin: .35rem 0; color: #e5e7eb }
    ul { margin: .4rem 0 .6rem 1.2rem; color: #e5e7eb }
    .callout { background: rgba(255,178,0,.08); border: 1px solid rgba(255,178,0,.25); border-radius: 12px; padding: 12px 14px; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 780px) { .grid-2 { grid-template-columns: 1fr; } }

    .sigbox { background: #0f0f11; border: 1px dashed #3a3b41; border-radius: 12px; padding: 14px; }
    .sigline { height: 28px; border-bottom: 2px solid rgba(255,255,255,.2); margin: 8px 0 6px 0; }
    .cursive { font-family: "Cinzel", serif; font-style: italic; font-weight: 600; letter-spacing: .3px; }
    .sig-input { display:block; width:100%; max-width:100%; box-sizing:border-box; background:#0d0d0f; border:1px solid #2f3036; color:#fff; padding:10px 12px; border-radius:8px; font-size:14px; overflow:hidden; text-overflow:ellipsis; }
    .sig-input::placeholder { color:#6b7280; }
    .sig-preview { font-family: 'Great Vibes', cursive; font-size: 24px; letter-spacing:.2px; color:#e5e7eb; max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sig-script { font-family: 'Great Vibes', cursive; font-size: 24px; letter-spacing:.2px; color:#e5e7eb; }

    .actions { padding: 18px 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: #0a0a0a; border-top: 1px solid var(--border); }
    .btn { appearance: none; display: inline-flex; align-items: center; gap:.6rem; border-radius: 10px; border: 1px solid #e6a300; padding: 10px 14px; font-weight: 800; cursor: pointer; text-decoration: none; }
    .btn-primary { background: linear-gradient(135deg, #FFB200, #FFD86B); color: #111; }
    .btn-secondary { background: rgba(255,255,255,.06); color: #fff; border-color: #3a3b41; }
    .muted { color: var(--muted) }
    .foot { padding: 14px 22px; text-align: center; color: #9ca3af; border-top: 1px solid var(--border); font-size: 12px; background: #0a0a0a }
    .btn[disabled] { opacity: .6; cursor: not-allowed; filter: grayscale(.1); }
    .ok-badge { background: rgba(16,185,129,.12); color:#10b981; border:1px solid rgba(16,185,129,.35); padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800 }
    .success-panel { background: rgba(16,185,129,.06); border: 1px solid rgba(16,185,129,.25); border-radius: 12px; padding: 14px; margin: 14px 20px; }
    .success-panel h3 { color:#d1fae5 }

    @media (max-width: 780px) {
      .wrap { margin: 16px auto; padding: 0 10px; }
      .section { padding: 14px; }
      .actions { position: sticky; bottom: 0; z-index: 50; padding: 12px; gap: 8px; }
      .head { grid-template-columns: 1fr; text-align: center; }
      .brand-logos { justify-content: center; }
    }
</style>
</head>
<body>
  <div class="wrap">
    <div class="doc" id="agreementRoot">
      <div class="head">
        <div class="brand-logos">
          <a href="https://inexsystemsdesigns.com" target="_blank" rel="noopener noreferrer"><img src="inex-logo.png" alt="INEX Website"></a>
          <a href="https://cochranfilms.com" target="_blank" rel="noopener noreferrer"><img src="logo-black.png" alt="Cochran Films Website"></a>
        </div>
        <div class="title">
          <h1>INEX Systems & Designs — Agreement</h1>
          <div class="sub">Cochran Films LLC — Systems Division · Date: <span id="today"></span> · <span id="contractId"></span></div>
        </div>
        <span class="badge"><i class="fa-solid fa-shield"></i>&nbsp; Digital Agreement</span>
      </div>

      <div class="section">
        <p><strong>Parties.</strong> This Agreement is between <strong>Cochran Films LLC — Systems Division</strong> (“Provider”) and <strong>INEX Systems & Designs</strong> (“Client”).</p>
        <p><strong>Project.</strong> Design and deployment of an INEX‑branded operations portal (“Portal”) extending ClickShare room simplicity into client experience and internal operations.</p>
      </div>

      <div class="section">
        <h2>1) Scope & Deliverables</h2>
        <ul>
          <li><strong>Portal 2.0 (Dark) + 1.0 (Light):</strong> SPA‑style UI with Dashboard, Projects, Jobs/Dispatch, Inventory, RMA/Warranties, SLAs/Reports, Knowledge, Clients, Careers, Settings.</li>
          <li><strong>Branding:</strong> INEX logo & color tokens; favicon & metadata; press‑ready screenshots.</li>
          <li><strong>Inline Charts:</strong> SVG sparklines & bar charts (no third‑party libs) for KPIs + Operations Pulse.</li>
          <li><strong>Mock Data Layer:</strong> JSON‑based mock API prepared for connectors (Sheets/CSV, QuickBooks, Stripe).</li>
          <li><strong>Deployment:</strong> Static hosting to <em>inex.cochranfilms.com</em> (or Client domain).</li>
          <li><strong>Documentation:</strong> README and pitch overlay (navigation map, roadmap, handoff).</li>
        </ul>
      </div>

      <div class="section">
        <h2>2) Security</h2>
        <p><strong>Authentication:</strong> Option to add Firebase Auth (Phase 2) for login and role scoping.</p>
        <p><strong>Data at Rest:</strong> If JSON or files will store Client data, Provider can apply <strong>AES‑256 encryption</strong> prior to storage; keys held in environment variables or a cloud KMS. <strong>Data in transit</strong> via HTTPS/TLS.</p>
        <p><strong>Access Control:</strong> Least‑privilege service accounts; code review for production changes.</p>
        <p><strong>Confidentiality:</strong> Both parties protect non‑public information and use it solely for this Project.</p>
        <div class="callout"><strong>Note:</strong> If Client prefers, encrypted JSON can be replaced with a managed database (e.g., Firestore/Postgres) with field‑level encryption and audit trails.</div>
      </div>

      <div class="section">
        <h2>3) Timeline</h2>
        <p>Phase 1 (Prototype Polish): 1–2 weeks from approval.<br>
           Phase 2 (Auth + Connectors): 2–4 weeks, depending on integrations.<br>
           Phase 3 (Client Portal & Reports): 2–3 weeks.</p>
      </div>

      <div class="section">
        <h2>4) Fees & Payment</h2>
        <ul>
          <li><strong>One‑Time Implementation:</strong> <strong>$4,500</strong> (50% at kickoff, 50% at Phase 1 delivery).</li>
          <li><strong>Managed Care Plan:</strong> <strong>$150/month</strong> – uptime monitoring, small fixes, monthly content updates (≤2 hrs), priority support.</li>
          <li><strong>Out‑of‑Scope:</strong> Custom features, third‑party SaaS fees (e.g., QuickBooks/Stripe), change requests @ $85/hr (pre‑approved).</li>
        </ul>
      </div>

      <div class="section">
        <h2>5) Support & SLAs</h2>
        <p><strong>Targets:</strong> P1 – 30m response / 4h fix; P2 – 2h / 8h; P3 – 4h / 24h (business hours unless 24/7 plan selected).</p>
        <p><strong>Channels:</strong> Email & phone; emergency line available for 24/7 clients.</p>
        <p><strong>RMA/Warranty Tracking:</strong> Vendor terms govern physical replacements; Portal provides workflow and evidence trail.</p>
      </div>

      <div class="section">
        <h2>6) IP Ownership</h2>
        <p>Provider retains ownership of the core portal framework/components. Client receives a perpetual, non‑exclusive license to use within its business. Client owns Client Content and data.</p>
      </div>

      <div class="section">
        <h2>7) Acceptance, Warranty, Termination</h2>
        <p><strong>Acceptance:</strong> Deemed accepted once working on staging URL without material defects.</p>
        <p><strong>Warranty:</strong> 30‑day conformance warranty to Scope; fixes included.</p>
        <p><strong>Termination:</strong> Either party may terminate with 14 days’ notice after uncured material breach. Client pays for work to date and receives in‑progress deliverables.</p>
      </div>

      <div class="section">
        <h2>8) Compliance & Data Processing</h2>
        <p>Provider processes Client data solely to perform the Project. If required, parties will execute a Data Processing Addendum (DPA) covering encryption, retention, and deletion.</p>
      </div>

      <div class="section">
        <h2>Signatures</h2>
        <div class="grid-2">
          <div class="sigbox">
            <p><strong>Client: INEX Systems & Designs</strong></p>
            <label for="clientSignatureInput" class="muted" style="display:block;margin-top:6px;margin-bottom:6px">Type your full name to sign <span id="signatureReady" class="ok-badge" style="display:none"><i class="fa-solid fa-check"></i> Signature Ready</span></label>
            <input id="clientSignatureInput" class="sig-input" type="text" placeholder="Full legal name" autocomplete="off" spellcheck="false">
            <div class="sigline"></div>
            <p class="sig-preview" id="clientSignaturePreview">Zebadiah Henry</p>
            <p class="muted" style="margin-top:6px">Date: <span id="dateInex"></span></p>
          </div>
          <div class="sigbox">
            <p><strong>Provider: Cochran Films LLC — Systems Division</strong></p>
            <div class="sigline"></div>
            <p class="sig-script">Cody Cochran — Founder & CEO</p>
            <p class="muted" style="margin-top:6px">Date: <span id="dateCochran"></span></p>
          </div>
        </div>
      </div>

      <div class="actions">
        <span id="progressIndicator" class="muted">Step 1 of 2: Sign</span>
        <button id="finalizeBtn" class="btn btn-primary" disabled><i class="fa-solid fa-file-signature"></i> Sign & Send Contract</button>
      </div>

      <div id="successPanel" class="success-panel" style="display:none">
        <h3><i class="fa-solid fa-circle-check" style="color:#10b981"></i> Agreement finalized</h3>
        <p class="muted" id="emailConfirm" style="margin:6px 0 10px">Contract signed and emails sent successfully.</p>
        <p class="muted" style="margin:6px 0 10px; font-size: 12px;">The signed contract has been sent to your email. You can also download a copy below if needed.</p>
        <button id="downloadBtn" class="btn btn-secondary"><i class="fa-solid fa-download"></i> Download Agreement PDF</button>
      </div>

      <div class="foot">© Cochran Films LLC — Systems Division</div>
    </div>
  </div>

<script>
    // Initialize dates and contract ID
    const now = new Date();
    const todayStr = now.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'2-digit'});
    const contractId = 'INEX-' + now.getFullYear() + (now.getMonth()+1).toString().padStart(2,'0') + '-' + Math.random().toString(36).slice(2,8).toUpperCase();
    document.getElementById('today').textContent = todayStr;
    document.getElementById('contractId').textContent = contractId;
    document.getElementById('dateInex').textContent = todayStr;
    document.getElementById('dateCochran').textContent = todayStr;

    // (Email is now sent server-side for key protection)



    // EmailJS Configuration for contract notifications
    const EMAILJS_CONFIG = {
      publicKey: 'p4pF3OWvh-DXtae4c', // Your EmailJS public key
      serviceId: 'service_t11yvru',    // Your EmailJS service ID
      templateId: 'template_n89b1e3',  // Admin notification template
      userTemplateId: 'template_n89b1e3' // User confirmation template - replace with your actual EmailJS template ID
    };

    // Initialize EmailJS
    if (typeof emailjs !== 'undefined') {
      emailjs.init(EMAILJS_CONFIG.publicKey);
      console.log('✅ EmailJS initialized successfully');
    } else {
      console.warn('⚠️ EmailJS library not loaded');
    }

    // helpers
    // API resolution: try same-origin first; if missing (e.g., static hosting), fall back to Vercel URLs
    const urlParams = new URLSearchParams(location.search);
    const apiOverride = (window.INEX_API_BASE || urlParams.get('api') || '').replace(/\/$/, '');
    // Only try explicit override and same-origin to avoid noisy 404/CORS from non-existent projects
    const API_CANDIDATES = [
      apiOverride,
      '', // same-origin last (static hosting may not have api)
    ].filter(Boolean);
    async function apiFetch(path, init){
      let lastErr;
      for (const base of API_CANDIDATES){
        try{
          const res = await fetch(`${base}${path}`, init);
          if (res.ok) return res;
          // If 404/405, try next base
          lastErr = new Error(`API ${path} @ ${base||'same-origin'} -> ${res.status}`);
          console.warn('[INEX API]', String(lastErr.message));
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error('API unreachable');
    }

    async function initFirebasePublic() {
      try {
        // Use local config for development, fallback to API for production
        let cfg;
        if (window.FIREBASE_CONFIG && window.FIREBASE_CONFIG.apiKey) {
          // Use local development config
          cfg = window.FIREBASE_CONFIG;
          console.log('Using local Firebase config');
        } else {
          // Try API endpoint for production
          try {
            const cfgRes = await apiFetch('/api/firebase/public-config');
            if (!cfgRes.ok) {
              console.warn('Firebase public config missing from API');
              return;
            }
            cfg = await cfgRes.json();
          } catch (e) {
            console.warn('Firebase API unreachable, using local config fallback', e?.message);
            return;
          }
        }
        
        if (!cfg?.apiKey) {
          console.warn('Firebase configuration incomplete');
          return;
        }
        
        firebase.initializeApp(cfg);
        window.firebaseAuth = firebase.auth();
        console.log('Firebase client initialized');
      } catch (e) { 
        console.warn('Firebase init failed', e); 
      }
    }
    
    // Minimal inline email/password gate (for Cody + Zeb testing)
    // If you have created accounts in Firebase Auth, this will allow immediate sign-in.
    async function ensureTestAuthGate(){
      try{
        const hasFirebase = !!window.firebaseAuth;
        const user = hasFirebase ? window.firebaseAuth.currentUser : null;
        if (hasFirebase && user && isAllowedEmail(user.email)) return; // already signed in & allowed
        // Create a lightweight banner with email+password inputs
        const root = document.querySelector('.head');
        if (!root || document.getElementById('authGate')) return;
        const gate = document.createElement('div');
        gate.id = 'authGate';
        gate.style.cssText = 'grid-column:1/-1;background:rgba(255,255,255,.04);border:1px solid #3a3b41;border-radius:12px;padding:10px 12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap';
        gate.innerHTML = `
          <span class="muted" style="font-weight:800">Restricted Access</span>
          <input id="authEmail" class="sig-input" placeholder="Email" style="max-width:240px">
          ${hasFirebase ? '<input id="authPass" class="sig-input" placeholder="Password" type="password" style="max-width:180px">' : ''}
          <button id="authLoginBtn" class="btn btn-secondary"><i class="fa-solid fa-right-to-bracket"></i> Sign In</button>
          <span id="authStatus" class="muted" style="margin-left:6px"></span>
        `;
        root.parentNode.insertBefore(gate, root.nextSibling);
        const status = gate.querySelector('#authStatus');
        gate.querySelector('#authLoginBtn').addEventListener('click', async ()=>{
          const e = gate.querySelector('#authEmail').value.trim();
          if (!e) { status.textContent = 'Enter your email'; return; }
          if (hasFirebase) {
            const p = gate.querySelector('#authPass').value;
            if (!p) { status.textContent = 'Enter password'; return; }
            try{
              status.textContent = 'Signing in…';
              await window.firebaseAuth.signInWithEmailAndPassword(e,p);
              if (!isAllowedEmail(e)) { await window.firebaseAuth.signOut(); status.textContent = 'Email not permitted'; return; }
              status.textContent = 'Signed in';
              gate.style.display = 'none';
            }catch(err){
              status.textContent = 'Sign-in failed';
              console.warn('auth error', err?.message);
            }
          } else {
            // Fallback: simple allowlist check without Firebase
            if (!isAllowedEmail(e)) { status.textContent = 'Email not permitted'; return; }
            window.__accessGranted = true;
            status.textContent = 'Access granted';
            gate.style.display = 'none';
          }
        });
      }catch(_){ }
    }
    function isValidFullName(name){
      if (!name) return false;
      const cleaned = String(name).trim().replace(/\s+/g,' ');
      const parts = cleaned.split(' ');
      if (parts.length < 2) return false;
      if (cleaned.length < 6) return false;
      const partOk = /^[A-Za-z][A-Za-z'\-]{1,}$/;
      return parts.every(p => partOk.test(p));
    }
    // Allowed emails (gate access) — base list + optional overrides (query/local)
    function getAllowedEmails(){
      const base = ['info@inexsystemsdesigns.com','info@cochranfilms.com'];
      try{
        const qp = new URLSearchParams(location.search).get('allow');
        if (qp) qp.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean).forEach(e=>{ if(!base.includes(e)) base.push(e); });
      }catch(_){ }
      try{
        const winList = Array.isArray(window.ALLOWED_EMAILS) ? window.ALLOWED_EMAILS : [];
        winList.map(s=>String(s||'').trim().toLowerCase()).filter(Boolean).forEach(e=>{ if(!base.includes(e)) base.push(e); });
      }catch(_){ }
      return base;
    }
    function isAllowedEmail(email){
      if (!email) return false;
      return getAllowedEmails().includes(String(email).trim().toLowerCase());
    }
    async function hydrateAllowedFromJson(){
      try{
        const res = await fetch('allowed-users.json', { cache: 'no-store' });
        if (!res.ok) return;
        const data = await res.json();
        if (Array.isArray(data?.allowedEmails)) {
          window.ALLOWED_EMAILS = (window.ALLOWED_EMAILS || []).concat(
            data.allowedEmails.map(e=>String(e||'').trim().toLowerCase()).filter(Boolean)
          );
        }
      }catch(_){ }
    }
    async function completeSignInIfNeeded(){
      try{
        if (!window.firebaseAuth) return; // Firebase not available (static mode)
        const href = window.location.href;
        if (window.firebaseAuth.isSignInWithEmailLink(href)){
          let email = window.localStorage.getItem('emailForSignIn');
          if (!email) email = prompt('Confirm your email to complete sign-in');
          if (!email) return;
          const cred = await window.firebaseAuth.signInWithEmailLink(email, href);
          window.localStorage.removeItem('emailForSignIn');
          const authedEmail = cred?.user?.email || email;
          if (!isAllowedEmail(authedEmail)){
            alert('Access restricted. This page is limited to authorized emails.');
            try { await window.firebaseAuth.signOut(); } catch(_){ }
          } else {
            console.log('Signed in as', authedEmail);
          }
        }
      }catch(e){ console.warn('Complete sign-in failed', e); }
    }
    async function loadImageAsDataURL(url){
      const res = await fetch(url);
      const blob = await res.blob();
      return await new Promise((resolve)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.readAsDataURL(blob); });
    }

    function buildContractData(){
      return {
        contractId: contractId,
        effectiveDate: todayStr,
        clientName: 'INEX Systems & Designs',
        providerName: 'Cochran Films LLC — Systems Division',
        amount: '$4,500',
        carePlan: '$150/month',
        scopeSummary: 'INEX‑branded Operations Portal (Dashboard, Jobs, Inventory, RMA, SLAs, Clients, Careers) with documentation and deployment.',
        projectScopeSummary: 'INEX‑branded Operations Portal (Dashboard, Jobs, Inventory, RMA, SLAs, Clients, Careers) with documentation and deployment.',
        contactName: 'Zebadiah Henry',
        contactEmail: INEX_NOTIFICATION_EMAIL || '{{to_email}}',
        clientSignature: (document.getElementById('clientSignatureInput')?.value || '').trim()
      };
    }

    // High-fidelity HTML-to-PDF (Letter) generation using jsPDF.html
    async function generateHTMLPDF(data){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'letter' }); // 612x792 pt
      const node = document.getElementById('pdfTemplate');
      if (!node) throw new Error('Missing #pdfTemplate');
      // Inject dynamic values
      node.querySelector('[data-contract-id]').textContent = data.contractId;
      node.querySelector('[data-effective-date]').textContent = data.effectiveDate;
      node.querySelector('[data-amount]').textContent = data.amount;
      node.querySelector('[data-care-plan]').textContent = data.carePlan;
      node.querySelector('[data-provider-date]').textContent = data.effectiveDate;
      node.querySelector('[data-client-date]').textContent = data.effectiveDate;
      node.querySelector('[data-client-sign]').textContent = data.clientSignature || 'Zebadiah Henry';
      const companySig = node.querySelector('[data-company-sign]');
      if (companySig) companySig.textContent = 'Cody Cochran';
      const stamp = node.querySelector('#pdf-print-stamp');
      if (stamp) stamp.textContent = new Date().toLocaleString();
      // Ensure fonts and layout are ready before rasterizing
      try { if (document.fonts && document.fonts.ready) { await document.fonts.ready; } } catch(_){}
      await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
      return await new Promise((resolve, reject)=>{
        try {
          doc.html(node, {
            x: 0, y: 0, width: 612,
            html2canvas: { scale: 1.1, useCORS: true, allowTaint: true, windowWidth: Math.max(612, node.scrollWidth || 612) },
            callback: (d)=> {
              // Remove extra trailing blank page produced by renderer in some cases
              try { if (d.internal.getNumberOfPages() > 1) { d.deletePage(d.internal.getNumberOfPages()); } } catch(_){ }
              resolve(d);
            }
          });
        } catch(e){ reject(e); }
      });
    }

    // Alternative, ultra-reliable method: render node via html2canvas and tile into pages
    async function generateCanvasPDF(data){
      const { jsPDF } = window.jspdf;
      const node = document.getElementById('pdfTemplate');
      if (!node) throw new Error('Missing #pdfTemplate');
      const doc = new jsPDF({ unit: 'pt', format: 'letter' });
      // Ensure node values are current
      node.querySelector('[data-contract-id]').textContent = data.contractId;
      node.querySelector('[data-effective-date]').textContent = data.effectiveDate;
      node.querySelector('[data-amount]').textContent = data.amount;
      node.querySelector('[data-care-plan]').textContent = data.carePlan;
      node.querySelector('[data-provider-date]').textContent = data.effectiveDate;
      node.querySelector('[data-client-date]').textContent = data.effectiveDate;
      node.querySelector('[data-client-sign]').textContent = data.clientSignature || 'Zebadiah Henry';
      const stamp = node.querySelector('#pdf-print-stamp');
      if (stamp) stamp.textContent = new Date().toLocaleString();
      try { if (document.fonts && document.fonts.ready) { await document.fonts.ready; } } catch(_){}
      await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
      const canvas = await html2canvas(node, { scale: 2, useCORS: true, allowTaint: true });
      const imgWidthPt = 612; // page width
      const pageHeightPt = 792; // letter height
      const pageCanvas = document.createElement('canvas');
      const pageCtx = pageCanvas.getContext('2d', { willReadFrequently: true });
      const ratio = canvas.width / imgWidthPt; // px per pt
      const pageHeightPx = Math.floor(pageHeightPt * ratio);
      let rendered = false;
      for (let topPx = 0, page = 0; topPx < canvas.height; topPx += pageHeightPx, page++) {
        const sliceHeight = Math.min(pageHeightPx, canvas.height - topPx);
        pageCanvas.width = canvas.width;
        pageCanvas.height = sliceHeight;
        pageCtx.clearRect(0,0,pageCanvas.width,pageCanvas.height);
        pageCtx.drawImage(canvas, 0, topPx, canvas.width, sliceHeight, 0, 0, canvas.width, sliceHeight);
        const imgData = pageCanvas.toDataURL('image/png');
        if (page > 0) doc.addPage();
        const sliceHeightPt = sliceHeight / ratio;
        doc.addImage(imgData, 'PNG', 0, 0, imgWidthPt, sliceHeightPt, undefined, 'FAST');
        rendered = true;
      }
      // Remove a trailing blank page if html2canvas returned height rounding that created an extra page
      try { if (rendered && doc.internal.getCurrentPageInfo().pageNumber > 1) {
        const lastPage = doc.internal.getCurrentPageInfo().pageNumber;
        // Heuristic: if the last page height is effectively empty, delete it
        // jsPDF doesn't expose page content metrics; instead, track if the last sliceHeightPt was very small
      } } catch(_){}
      return doc;
    }

    async function generateINEXPDF(data){
      // Prefer HTML-based rendering for perfect layout
      // Try Canvas tiling renderer first (most reliable across browsers)
      try { return await generateCanvasPDF(data); } catch (e) { console.warn('Canvas PDF failed:', e); }
      // Try jsPDF.html as a secondary approach
      try { return await generateHTMLPDF(data); } catch (e2) { console.warn('HTML PDF failed:', e2); }
      const { jsPDF } = window.jspdf; const doc = new jsPDF();
      // header banner
      doc.setFillColor(255,178,0); doc.rect(0,0,210,24,'F');
      doc.setFont('helvetica','bold'); doc.setTextColor(0,0,0); doc.setFontSize(18);
      doc.text('INEX SYSTEMS & DESIGNS — AGREEMENT',105,12,{align:'center'});
      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      doc.text('Cochran Films LLC — Systems Division',105,19,{align:'center'});

      // logos
      try{
        const [inexLogo, cfLogo] = await Promise.all([
          loadImageAsDataURL('inex-logo.png'),
          loadImageAsDataURL('logo-black.png')
        ]);
        doc.addImage(inexLogo,'PNG',14,6,18,12);
        doc.addImage(cfLogo,'PNG',178,6,18,12);
      }catch{ /* continue without images */ }

      // meta
      doc.setTextColor(80,80,80); doc.setFontSize(9);
      doc.text(`Contract ID: ${data.contractId}`, 20, 32);
      doc.text(`Effective Date: ${data.effectiveDate}`, 20, 36);

      // sections
      const line = (x1,y,x2)=>{ doc.setDrawColor(255,178,0); doc.setLineWidth(0.3); doc.line(x1,y,x2,y); };
      let y=44;
      function header(txt){ doc.setFillColor(255,178,0); doc.rect(20,y-6,170,7,'F'); doc.setTextColor(0,0,0); doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.text(txt,105,y-1,{align:'center'}); }
      function t(txt,dy=5){ doc.setFont('helvetica','normal'); doc.setFontSize(8); doc.setTextColor(0,0,0); doc.text(txt,22,y+=dy); }

      header('PROJECT OVERVIEW');
      y+=6; t('Parties: Cochran Films LLC — Systems Division (Provider) and INEX Systems & Designs (Client).');
      t('Project: INEX‑branded operations portal with branded UI, modules, deployment, and documentation.');

      y+=6; header('SCOPE & DELIVERABLES'); y+=6;
      const scope = [
        'Portal 2.0 (Dark) + 1.0 (Light): Dashboard, Projects, Jobs/Dispatch, Inventory, RMA/Warranties, SLAs/Reports, Knowledge, Clients, Careers, Settings.',
        'Branding: INEX logo & color tokens; favicon & metadata; press‑ready screenshots.',
        'Inline Charts: SVG sparklines & bar charts for KPIs and Operations Pulse.',
        'Mock Data Layer: JSON‑based mock API prepared for connectors (Sheets/CSV, QuickBooks, Stripe).',
        'Deployment: Static hosting to inex.cochranfilms.com (or client domain).',
        'Documentation: README and pitch overlay (navigation map, roadmap, handoff).'
      ];
      scope.forEach((s)=>{ t('\u2022 ' + s, 5); });

      y+=6; header('FEES & PAYMENT'); y+=6;
      t(`One‑Time Implementation: ${data.amount} (50% at kickoff, 50% at Phase 1 delivery).`);
      t(`Managed Care Plan: ${data.carePlan} for monitoring, small fixes, monthly updates (≤2 hrs), priority support.`);
      t('Out‑of‑Scope: Custom features, third‑party SaaS fees; change requests @ $85/hr (pre‑approved).');

      y+=6; header('SECURITY & COMPLIANCE'); y+=6;
      t('Authentication (Phase 2): optional Firebase Auth with role scoping.');
      t('Data at Rest: AES‑256 encryption available; keys in env/KMS. Data in Transit: HTTPS/TLS.');
      t('Access Control: least‑privilege accounts; code review for production.');
      t('Confidentiality: both parties protect non‑public information.');

      // signatures
      y+=8; header('SIGNATURES'); y+=8;
      doc.setFontSize(8); doc.setTextColor(0,0,0);
      // Provider block
      doc.text('COCHRAN FILMS (COMPANY)', 22, y);
      line(22, y+13, 95); doc.text('Authorized Signature:', 22, y+9);
      doc.setFont('helvetica','italic'); doc.setFontSize(12); doc.text('Cody Cochran', 22, y+12);
      doc.setFont('helvetica','normal'); doc.setFontSize(7); doc.text('Title: Founder & CEO', 22, y+18); doc.text('Date: '+data.effectiveDate, 22, y+22);

      // Client block
      doc.setFont('helvetica','bold'); doc.setFontSize(8); doc.text('INEX SYSTEMS & DESIGNS (CLIENT)', 115, y);
      line(115, y+13, 188); doc.setFont('helvetica','normal'); doc.setFontSize(7); doc.text('Authorized Signature:', 115, y+9);
      doc.setFont('helvetica','italic'); doc.setFontSize(12); doc.text(data.clientSignature || 'Zebadiah Henry', 115, y+12);
      doc.setFont('helvetica','normal'); doc.setFontSize(7); doc.text('Title: Authorized Representative', 115, y+18); doc.text('Date: '+data.effectiveDate, 115, y+22);

      // footer
      const footerY = 270 - 18; doc.setDrawColor(255,178,0); doc.rect(20, footerY-4, 170, 18, 'S');
      doc.setTextColor(100,100,100); doc.setFontSize(7);
      doc.text('Digitally generated by Cochran Films Contract System · Contract ID: '+data.contractId, 105, footerY+2, {align:'center'});
      doc.text(new Date().toLocaleString(), 105, footerY+7, {align:'center'});
      return doc;
    }

    async function finalizeOnServer(payload){
      try {
        // Generate contract data locally
        const contractData = buildContractData();
        const now = new Date();
        
        // Create contract ID and effective date
        const contractId = 'INEX-' + now.getFullYear() + (now.getMonth()+1).toString().padStart(2,'0') + '-' + Math.random().toString(36).slice(2,8).toUpperCase();
        const effectiveDate = now.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'2-digit'});
        
        // Send admin notification email
        if (typeof emailjs !== 'undefined') {
          const adminEmailParams = {
            to_email: INEX_NOTIFICATION_EMAIL,
            contract_id: contractId,
            effective_date: effectiveDate,
            client_name: contractData.clientSignature,
            company_name: 'INEX Systems & Designs',
            client_signature: contractData.clientSignature,
            signed_timestamp: now.toLocaleString(),
            amount: contractData.amount || '$4,500',
            care_plan: contractData.carePlan || '$150/month',
            project_scope_summary: contractData.projectScopeSummary || 'INEX‑branded Operations Portal (Dashboard, Jobs, Inventory, RMA, SLAs, Clients, Careers) with documentation and deployment.',
            portal_url: window.location.href
          };
          
          await emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.templateId, adminEmailParams);
          console.log('✅ Admin notification email sent');
        }
        
        // Send user confirmation email
        if (typeof emailjs !== 'undefined' && payload.contactEmail) {
          const userEmailParams = {
            to_email: payload.contactEmail,
            contract_id: contractId,
            effective_date: effectiveDate,
            client_name: contractData.clientSignature,
            company_name: 'INEX Systems & Designs',
            client_signature: contractData.clientSignature,
            signed_timestamp: now.toLocaleString(),
            amount: contractData.amount || '$4,500',
            care_plan: contractData.carePlan || '$150/month',
            project_scope_summary: contractData.projectScopeSummary || 'INEX‑branded Operations Portal (Dashboard, Jobs, Inventory, RMA, SLAs, Clients, Careers) with documentation and deployment.',
            portal_url: window.location.href
          };
          
          await emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.userTemplateId, userEmailParams);
          console.log('✅ User confirmation email sent');
        }
        
        // Return the generated contract data
        return {
          contractId: contractId,
          effectiveDate: effectiveDate,
          amount: contractData.amount || '$4,500',
          carePlan: contractData.carePlan || '$150/month',
          toEmail: payload.contactEmail || ''
        };
      } catch (error) {
        console.error('Email sending failed:', error);
        throw new Error('Failed to send contract emails: ' + error.message);
      }
    }

    // UI Actions
    const finalizeBtn = document.getElementById('finalizeBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    let lastDoc = null; let lastData = null;

    // Live signature preview updates
    const clientInput = document.getElementById('clientSignatureInput');
    const clientPreview = document.getElementById('clientSignaturePreview');
    const sigReady = document.getElementById('signatureReady');
    const progressIndicator = document.getElementById('progressIndicator');
    if (clientInput && clientPreview) {
      const updatePreview = ()=>{
        const v = clientInput.value.trim();
        clientPreview.textContent = v || 'Zebadiah Henry';
        const valid = isValidFullName(v);
        if (sigReady) sigReady.style.display = valid ? 'inline-block' : 'none';
        const finalizeBtn = document.getElementById('finalizeBtn');
        if (finalizeBtn) finalizeBtn.disabled = !valid;
        if (progressIndicator) progressIndicator.textContent = valid ? 'Step 2 of 2: Send Contract' : 'Step 1 of 2: Sign';
      };
      clientInput.addEventListener('input', updatePreview);
      updatePreview();
      setTimeout(()=>{ try { clientInput.focus(); } catch(_){} }, 0);
    }

    finalizeBtn.addEventListener('click', async ()=>{
      finalizeBtn.disabled = true; finalizeBtn.innerHTML = '<i class="fa-solid fa-hourglass-half"></i> Processing...';
      try{
        // Ensure logged-in access before showing contract
        try { await initFirebasePublic(); } catch(_){ }
        try { await ensureTestAuthGate(); } catch(_){ }
        if (window.firebaseAuth) {
          // Show lightweight login if not signed in
          const user = window.firebaseAuth.currentUser;
          if (!user) {
            const email = (document.getElementById('freelancerEmail')?.value || '').trim();
            let promptEmail = email || prompt('Enter your email to verify access');
            if (!promptEmail) throw new Error('Email required for verification');
            if (!isAllowedEmail(promptEmail)) { alert('Access restricted to authorized emails.'); throw new Error('Unauthorized email'); }
            try {
              await window.firebaseAuth.sendSignInLinkToEmail(promptEmail, {
                url: window.location.href,
                handleCodeInApp: true,
              });
              try { window.localStorage.setItem('emailForSignIn', promptEmail); } catch(_){ }
              alert('A secure sign-in link was sent to your email. Open it on this device to continue.');
              finalizeBtn.disabled = false; finalizeBtn.innerHTML = '<i class="fa-solid fa-file-signature"></i> Sign & Send Contract';
              return;
            } catch (e) { console.warn('Link sign-in failed', e); }
          }
          // If signed in, enforce allowlist
          try {
            const authedEmail = window.firebaseAuth.currentUser?.email;
            if (!isAllowedEmail(authedEmail)) { alert('Access restricted to authorized emails.'); throw new Error('Unauthorized email'); }
          } catch(_){ /* handled by catch below */ }
        } else {
          // No Firebase available: require allowlist verification via gate
          if (!window.__accessGranted) {
            alert('Please verify your email to continue.');
            try { document.getElementById('authGate')?.scrollIntoView({ behavior: 'smooth' }); } catch(_){ }
            finalizeBtn.disabled = false; finalizeBtn.innerHTML = '<i class="fa-solid fa-file-signature"></i> Sign & Send Contract';
            return;
          }
        }
        lastData = buildContractData();
        // Require client signature
        if (!isValidFullName(lastData.clientSignature)) {
          alert('Please type your full legal name to sign (first and last).');
          finalizeBtn.disabled = false; finalizeBtn.innerHTML = '<i class="fa-solid fa-file-signature"></i> Finalize & Email';
          return;
        }
        // Finalize on server (authoritative data + email)
        const serverRes = await finalizeOnServer({
          clientSignature: lastData.clientSignature,
          contactEmail: lastData.contactEmail
        });
        // Apply server-authoritative values
        lastData.contractId = serverRes.contractId || lastData.contractId;
        lastData.effectiveDate = serverRes.effectiveDate || lastData.effectiveDate;
        lastData.amount = serverRes.amount || lastData.amount;
        lastData.carePlan = serverRes.carePlan || lastData.carePlan;
        // Generate PDF with the authoritative values
        lastDoc = await generateINEXPDF(lastData);
        try { if (lastDoc.internal.getNumberOfPages() === 0) { lastDoc.addPage(); } } catch(_){ }
        // Success UI
        const successPanel = document.getElementById('successPanel');
        const emailConfirm = document.getElementById('emailConfirm');
        const sentTo = serverRes.toEmail || lastData.contactEmail || '';
        if (emailConfirm) emailConfirm.textContent = sentTo ? `Email sent to ${sentTo}` : 'Email sent.';
        if (successPanel) successPanel.style.display = 'block';
        const downloadBtn = document.getElementById('downloadBtn');
        if (downloadBtn) downloadBtn.style.display = 'inline-flex';
        finalizeBtn.innerHTML = '<i class="fa-solid fa-check"></i> Contract Sent';
      }catch(err){
        console.error(err); finalizeBtn.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Try Again'; finalizeBtn.disabled = false;
      }
    });

    downloadBtn.addEventListener('click', ()=>{
      if (!lastDoc || !lastData) return;
      const safe = 'INEX-Agreement-' + lastData.contractId + '.pdf';
      lastDoc.save(safe);
    });
    // Initialize public Firebase early (best effort) and show auth gate immediately
    // Hydrate allowlist first, then init Firebase, then show auth gate
    hydrateAllowedFromJson()
      .then(()=> initFirebasePublic())
      .then(()=>{ try{ completeSignInIfNeeded(); }catch(_){} return ensureTestAuthGate(); })
      .catch(()=>{});
</script>
  
  <!-- Hidden, print-accurate HTML template rendered to PDF (US Letter) -->
  <div id="pdfTemplate" style="position: fixed; left: -99999px; top: 0; width: 612pt; background:#fff; color:#000; font-family: Inter, Arial;">
    <div style="border:1px solid #e5e7eb;">
      <div style="background:#FFB200; color:#000; padding:14pt 16pt; display:flex; align-items:center; justify-content:space-between;">
        <div style="display:flex; align-items:center; gap:10pt;">
          <img src="inex-logo.png" style="height:18pt" alt="INEX">
          <div style="font:800 15pt/1 Inter, Arial; text-transform:uppercase;">INEX SYSTEMS & DESIGNS — AGREEMENT</div>
        </div>
        <img src="logo-black.png" style="height:18pt" alt="INEX Black">
      </div>
      <div style="padding:10pt 16pt; font:600 10pt/1.3 Inter, Arial; color:#111; border-bottom:1px solid #f0f0f0;">
        Cochran Films LLC — Systems Division · Contract ID: <span data-contract-id></span> · Effective Date: <span data-effective-date></span>
      </div>
      <div style="padding:16pt; font:10pt/1.5 Inter, Arial;">
        <div style="background:#FFB200; color:#000; font-weight:800; text-align:center; padding:6pt; margin-bottom:8pt;">PROJECT OVERVIEW</div>
        <div>Parties: Cochran Films LLC — Systems Division (Provider) and INEX Systems & Designs (Client).</div>
        <div>Project: INEX‑branded operations portal with branded UI, modules, deployment, and documentation.</div>

        <div style="background:#FFB200; color:#000; font-weight:800; text-align:center; padding:6pt; margin:12pt 0 8pt;">SCOPE & DELIVERABLES</div>
        <ul style="margin:0 0 8pt 14pt; color:#000;">
          <li>Portal 2.0 (Dark) + 1.0 (Light): Dashboard, Projects, Jobs/Dispatch, Inventory, RMA/Warranties, SLAs/Reports, Knowledge, Clients, Careers, Settings.</li>
          <li>Branding: INEX logo & color tokens; favicon & metadata; press‑ready screenshots.</li>
          <li>Inline Charts: SVG sparklines & bar charts for KPIs and Operations Pulse.</li>
          <li>Mock Data Layer: JSON‑based mock API prepared for connectors (Sheets/CSV, QuickBooks, Stripe).</li>
          <li>Deployment: Static hosting to inex.cochranfilms.com (or client domain).</li>
          <li>Documentation: README and pitch overlay (navigation map, roadmap, handoff).</li>
        </ul>

        <div style="background:#FFB200; color:#000; font-weight:800; text-align:center; padding:6pt; margin:12pt 0 8pt;">FEES & PAYMENT</div>
        <div>One‑Time Implementation: <span data-amount></span> (50% at kickoff, 50% at Phase 1 delivery).</div>
        <div>Managed Care Plan: <span data-care-plan></span> – monitoring, small fixes, monthly updates (≤2 hrs), priority support.</div>
        <div>Out‑of‑Scope: Custom features, third‑party SaaS fees; change requests @ $85/hr (pre‑approved).</div>

        <div style="background:#FFB200; color:#000; font-weight:800; text-align:center; padding:6pt; margin:12pt 0 8pt;">SECURITY & COMPLIANCE</div>
        <div>Authentication (Phase 2): optional Firebase Auth with role scoping.</div>
        <div>Data at Rest: AES‑256 encryption available; keys in env/KMS. Data in Transit: HTTPS/TLS.</div>
        <div>Access Control: least‑privilege accounts; code review for production.</div>
        <div>Confidentiality: both parties protect non‑public information.</div>

        <div style="background:#FFB200; color:#000; font-weight:800; text-align:center; padding:6pt; margin:12pt 0 8pt;">SIGNATURES</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:18pt;">
          <div style="border:1px solid #e5e7eb; padding:10pt;">
            <div style="font-weight:700">COCHRAN FILMS (COMPANY)</div>
            <div style="height:22pt; border-bottom:2px solid #d1d5db; margin:8pt 0 6pt"></div>
            <div style="font-family:'Great Vibes', cursive; font-size:22pt;" data-company-sign>Cody Cochran</div>
            <div style="font-size:9pt">Title: Founder & CEO</div>
            <div style="font-size:9pt">Date: <span data-provider-date></span></div>
          </div>
          <div style="border:1px solid #e5e7eb; padding:10pt;">
            <div style="font-weight:700">INEX SYSTEMS & DESIGNS (CLIENT)</div>
            <div style="height:22pt; border-bottom:2px solid #d1d5db; margin:8pt 0 6pt"></div>
            <div style="font-family:'Great Vibes', cursive; font-size:22pt;" data-client-sign></div>
            <div style="font-size:9pt">Title: Authorized Representative</div>
            <div style="font-size:9pt">Date: <span data-client-date></span></div>
          </div>
        </div>
      </div>

      <div style="margin:16pt; border:1px solid #FFB200; padding:8pt 10pt; text-align:center; color:#6b7280; font-size:9pt;">
        Digitally generated by Cochran Films Contract System • Contract ID: <span data-contract-id></span>
        <div style="margin-top:4pt;">Printed: <span id="pdf-print-stamp">now</span></div>
      </div>
    </div>
  </div>
</body>
</html>