<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INEX System Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .status-display { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>INEX System Test</h1>
    
    <div class="test-section">
        <h2>Status Update System Test</h2>
        <p>Test the status update functionality that connects to GitHub and updates Zebediah's status page.</p>
        
        <div class="status-display">
            <strong>Current Status:</strong><br>
            Progress: <span id="currentProgress">Loading...</span><br>
            Phase: <span id="currentPhase">Loading...</span><br>
            Status: <span id="currentStatus">Loading...</span>
        </div>
        
        <button onclick="testStatusUpdate()">Test Status Update API</button>
        <button onclick="testPhaseChange()">Test Phase Change</button>
        <button onclick="testProgressIncrement()">Test Progress +10%</button>
        <button onclick="loadCurrentStatus()">Load Current Status</button>
        
        <div id="statusTestResults"></div>
    </div>
    
    <div class="test-section">
        <h2>Messaging System Test</h2>
        <p>Test the messaging system that automatically pushes messages to GitHub.</p>
        
        <form id="testMessageForm">
            <input type="text" id="testMessageName" placeholder="Your name" value="Test User">
            <textarea id="testMessageText" placeholder="Test message" rows="3">This is a test message to verify the system is working.</textarea>
            <button type="submit">Send Test Message</button>
        </form>
        
        <button onclick="loadTestMessages()">Load Messages</button>
        <button onclick="clearTestMessages()">Clear Test Messages</button>
        
        <div id="messageTestResults"></div>
        <div id="testMessagesList"></div>
    </div>
    
    <div class="test-section">
        <h2>System Information</h2>
        <div id="systemInfo"></div>
    </div>

    <script>
        // API Configuration
        const isDev = window.location.hostname === 'localhost' || 
                      window.location.hostname === '127.0.0.1' ||
                      window.location.port !== '' ||
                      window.location.protocol === 'file:';
        
        const API_BASE = isDev ? 'http://localhost:3000' : window.location.origin;
        const API_STATUS_UPDATE = `${API_BASE}/api/status-update`;
        const API_MESSAGES = `${API_BASE}/api/messages`;
        
        console.log('üîç Test Page API Configuration:');
        console.log('  isDev:', isDev);
        console.log('  API_BASE:', API_BASE);
        console.log('  API_STATUS_UPDATE:', API_STATUS_UPDATE);
        console.log('  API_MESSAGES:', API_MESSAGES);
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentStatus();
            loadTestMessages();
            displaySystemInfo();
        });
        
        // Status Update Tests
        async function testStatusUpdate() {
            const resultsDiv = document.getElementById('statusTestResults');
            resultsDiv.innerHTML = '<p class="info">Testing status update API...</p>';
            
            try {
                const response = await fetch(API_STATUS_UPDATE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        progress: 75,
                        phase: 'Testing',
                        status: 'System test in progress - verifying all functionality'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    resultsDiv.innerHTML = `<p class="success">‚úÖ Status update successful!</p><pre>${JSON.stringify(result, null, 2)}</pre>`;
                    loadCurrentStatus();
                } else {
                    const errorText = await response.text();
                    resultsDiv.innerHTML = `<p class="error">‚ùå Status update failed: ${response.status}</p><pre>${errorText}</pre>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }
        
        async function testPhaseChange() {
            const resultsDiv = document.getElementById('statusTestResults');
            resultsDiv.innerHTML = '<p class="info">Testing phase change...</p>';
            
            try {
                const response = await fetch(API_STATUS_UPDATE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        progress: 85,
                        phase: 'Phase 2',
                        status: 'Phase transition test - moving to Phase 2'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    resultsDiv.innerHTML = `<p class="success">‚úÖ Phase change successful!</p><pre>${JSON.stringify(result, null, 2)}</pre>`;
                    loadCurrentStatus();
                } else {
                    const errorText = await response.text();
                    resultsDiv.innerHTML = `<p class="error">‚ùå Phase change failed: ${response.status}</p><pre>${errorText}</pre>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }
        
        async function testProgressIncrement() {
            const resultsDiv = document.getElementById('statusTestResults');
            resultsDiv.innerHTML = '<p class="info">Testing progress increment...</p>';
            
            try {
                const currentProgress = parseInt(document.getElementById('currentProgress').textContent) || 0;
                const newProgress = Math.min(100, currentProgress + 10);
                
                const response = await fetch(API_STATUS_UPDATE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        progress: newProgress,
                        phase: 'Testing',
                        status: `Progress increment test - now at ${newProgress}%`
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    resultsDiv.innerHTML = `<p class="success">‚úÖ Progress increment successful!</p><pre>${JSON.stringify(result, null, 2)}</pre>`;
                    loadCurrentStatus();
                } else {
                    const errorText = await response.text();
                    resultsDiv.innerHTML = `<p class="error">‚ùå Progress increment failed: ${response.status}</p><pre>${errorText}</pre>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }
        
        async function loadCurrentStatus() {
            try {
                const response = await fetch('inex-live-data.json');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('currentProgress').textContent = data.progress + '%';
                    document.getElementById('currentPhase').textContent = data.phase;
                    document.getElementById('currentStatus').textContent = data.status;
                } else {
                    document.getElementById('currentProgress').textContent = 'Error loading';
                    document.getElementById('currentPhase').textContent = 'Error loading';
                    document.getElementById('currentStatus').textContent = 'Error loading';
                }
            } catch (error) {
                console.error('Error loading current status:', error);
            }
        }
        
        // Messaging Tests
        document.getElementById('testMessageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('testMessageName').value.trim();
            const text = document.getElementById('testMessageText').value.trim();
            
            if (!text) {
                alert('Please enter a message');
                return;
            }
            
            const resultsDiv = document.getElementById('messageTestResults');
            resultsDiv.innerHTML = '<p class="info">Sending test message...</p>';
            
            try {
                const response = await fetch(API_MESSAGES, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name || 'Test User',
                        text: text,
                        priority: 'normal',
                        category: 'test'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    resultsDiv.innerHTML = `<p class="success">‚úÖ Test message sent successfully!</p><pre>${JSON.stringify(result, null, 2)}</pre>`;
                    loadTestMessages();
                } else {
                    const errorText = await response.text();
                    resultsDiv.innerHTML = `<p class="error">‚ùå Message send failed: ${response.status}</p><pre>${errorText}</pre>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        });
        
        async function loadTestMessages() {
            try {
                const response = await fetch(API_MESSAGES);
                if (response.ok) {
                    const data = await response.json();
                    const messagesList = document.getElementById('testMessagesList');
                    
                    if (data.messages && data.messages.length > 0) {
                        messagesList.innerHTML = '<h3>Recent Messages:</h3>' + 
                            data.messages.slice(0, 5).map(msg => `
                                <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                    <strong>${msg.name}</strong> - ${new Date(msg.timestamp).toLocaleString()}<br>
                                    ${msg.text}
                                </div>
                            `).join('');
                    } else {
                        messagesList.innerHTML = '<p>No messages found.</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        
        function clearTestMessages() {
            document.getElementById('testMessagesList').innerHTML = '';
            document.getElementById('messageTestResults').innerHTML = '';
        }
        
        function displaySystemInfo() {
            const infoDiv = document.getElementById('systemInfo');
            infoDiv.innerHTML = `
                <p><strong>Environment:</strong> ${isDev ? 'Development' : 'Production'}</p>
                <p><strong>Hostname:</strong> ${window.location.hostname}</p>
                <p><strong>Port:</strong> ${window.location.port || 'Default'}</p>
                <p><strong>Protocol:</strong> ${window.location.protocol}</p>
                <p><strong>API Base:</strong> ${API_BASE}</p>
                <p><strong>Current Time:</strong> ${new Date().toLocaleString()}</p>
            `;
        }
    </script>
</body>
</html>
