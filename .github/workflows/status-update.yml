name: Status Update Workflow

on:
  workflow_dispatch:
    inputs:
      progress:
        description: 'Progress percentage (0-100)'
        required: true
        type: string
      phase:
        description: 'Current phase'
        required: true
        type: string
      status:
        description: 'Status description'
        required: true
        type: string

jobs:
  update-status:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Update status data
      run: |
        # Check if jq is available
        if ! command -v jq &> /dev/null; then
          echo "Installing jq..."
          sudo apt-get update && sudo apt-get install -y jq
        fi
        
        # Read existing data or create default structure
        if [ -f "inex-live-data.json" ]; then
          echo "Reading existing inex-live-data.json..."
          existing_data=$(cat inex-live-data.json)
        else
          echo "Creating new inex-live-data.json..."
          existing_data='{}'
        fi
        
        # Update the status fields while preserving other data
        updated_data=$(echo "$existing_data" | jq --arg progress "${{ inputs.progress }}" \
          --arg phase "${{ inputs.phase }}" \
          --arg status "${{ inputs.status }}" \
          --arg lastUpdated "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
          '.progress = ($progress | tonumber) | .phase = $phase | .status = $status | .lastUpdated = $lastUpdated')
        
        # Write the updated data back to file
        echo "$updated_data" > inex-live-data.json
        
        # Display the updated content
        echo "Updated inex-live-data.json:"
        cat inex-live-data.json
        
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add inex-live-data.json
        git commit -m "Update project status: ${{ inputs.phase }} - ${{ inputs.progress }}% - ${{ inputs.status }}"
        git push origin main
