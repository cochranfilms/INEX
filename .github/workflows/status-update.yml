name: Status Update & Deploy

on:
  workflow_dispatch:
    inputs:
      progress:
        description: 'Progress percentage'
        required: true
        default: '5'
      phase:
        description: 'Current phase'
        required: true
        default: 'Discovery'
      status:
        description: 'Status description'
        required: true
        default: 'Project kickoff initiated'
      update:
        description: 'Weekly update'
        required: false
      update_status:
        description: 'Update status'
        required: false
        default: 'In Progress'

jobs:
  update-status:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Update status files
      run: |
        echo "Updating status.html with new values..."
        echo "Progress: ${{ github.event.inputs.progress }}%"
        echo "Phase: ${{ github.event.inputs.phase }}"
        echo "Status: ${{ github.event.inputs.status }}"
        
        # Update status.html with new progress
        sed -i "s/id=\"pct\">.*%/id=\"pct\">${{ github.event.inputs.progress }}%/g" status.html
        sed -i "s/id=\"phaseLabel\">.*</id=\"phaseLabel\">${{ github.event.inputs.phase }}</g" status.html
        
        # Update progress bar
        sed -i "s/--bar:.*%/--bar:${{ github.event.inputs.progress }}%/g" status.html
        
        # Update ring progress
        sed -i "s/--p:.*/--p:${{ github.event.inputs.progress }}/g" status.html
        
        # Update status text if provided
        if [ -n "${{ github.event.inputs.status }}" ]; then
          sed -i "s/Current Status:.*</Current Status: ${{ github.event.inputs.status }}</g" status.html
        fi
        
        # Update ETA to match proposal timeline (Feb 2025)
        sed -i "s/ETA:.*2025/ETA: Feb 2025/g" status.html
        
        echo "Status files updated successfully"
        
    - name: Verify changes
      run: |
        echo "Verifying changes were made correctly..."
        echo "Progress in file:"
        grep -o 'id="pct">[^<]*' status.html
        echo "Phase in file:"
        grep -o 'id="phaseLabel">[^<]*' status.html
        echo "Progress bar:"
        grep -o '--bar:[^;]*' status.html
        echo "Ring progress:"
        grep -o '--p:[^;]*' status.html
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add status.html
        git commit -m "Status Update: ${{ github.event.inputs.phase }} - ${{ github.event.inputs.progress }}% - ${{ github.event.inputs.status }}"
        git push
        echo "Changes committed and pushed successfully"
        echo "Commit message: Status Update: ${{ github.event.inputs.phase }} - ${{ github.event.inputs.progress }}% - ${{ github.event.inputs.status }}"
        
    - name: Trigger Vercel deployment
      run: |
        if [ -n "${{ secrets.VERCEL_DEPLOY_HOOK }}" ]; then
          echo "Triggering Vercel deployment..."
          curl -X POST ${{ secrets.VERCEL_DEPLOY_HOOK }}
          echo "Vercel deployment triggered successfully"
        else
          echo "No Vercel deploy hook configured - skipping deployment trigger"
          echo "Note: Vercel will still auto-deploy when changes are pushed to main branch"
        fi
        
    - name: Workflow Summary
      run: |
        echo "ğŸ‰ Status Update Workflow Completed Successfully!"
        echo "================================================"
        echo "Progress: ${{ github.event.inputs.progress }}%"
        echo "Phase: ${{ github.event.inputs.phase }}"
        echo "Status: ${{ github.event.inputs.status }}"
        echo "Update: ${{ github.event.inputs.update || 'None' }}"
        echo "Update Status: ${{ github.event.inputs.update_status || 'In Progress' }}"
        echo ""
        echo "Changes have been committed and pushed to main branch."
        echo "Vercel will automatically deploy the updated status page."
        echo "Zebediah should see the changes in 2-3 minutes."
