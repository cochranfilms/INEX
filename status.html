<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>INEX Project Status — Public Status Page</title>
  <meta name="description" content="INEX Systems & Designs — Public project status and progress tracking for Phase 1: Prototype Polish phase." />
  <link rel="icon" type="image/svg+xml" href="vite.svg" />
  <link rel="alternate icon" type="image/x-icon" href="vite.ico" />
  
  <!-- Preload only essential resources that will be used immediately -->
  <link rel="preload" href="inex-logo.png" as="image" type="image/png">
  
  <style>
    :root{
      --inex-charcoal:#191919;
      --maroon:#A62E3F; --maroon-700:#7c2330;
      --ink:#111; --muted:#666; --border:#e6e6e6;
      --bg:#f5f6f8; --panel:#ffffff; --panel-ink:#222;
      --accent:#FFB200; --accent-ink:#111;
      --radius:16px; --radius-sm:12px;
      --shadow:0 3px 16px rgba(0,0,0,.08);
    }
    html[data-theme="dark"]{
      --ink:#e8ecf6; --muted:#9fa8bc; --border:rgba(255,255,255,.12);
      --bg:#08090e; --panel:rgba(18,20,28,.65); --panel-ink:#e9edf7;
      --shadow:0 24px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.05);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--panel-ink);
         font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
         letter-spacing:.2px}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:.8rem;padding:.9rem 1.1rem;background:var(--inex-charcoal);color:#fff;border-bottom:3px solid #2a2a2a}
    html[data-theme="dark"] .topbar{background:linear-gradient(180deg, rgba(8,9,14,.9), rgba(8,9,14,.6));border-bottom:1px solid var(--border);backdrop-filter: blur(10px)}
    .brand{display:flex;align-items:center;gap:.7rem;font-weight:900}
    .brand img{height:34px;width:auto;filter:drop-shadow(0 2px 8px rgba(0,0,0,.35))}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.55rem .8rem;border-radius:12px;border:1px solid transparent;text-decoration:none;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--maroon);color:#fff;border-color:var(--maroon-700)}
    .btn.ghost{background:rgba(255,255,255,.06);color:#fff;border-color:rgba(255,255,255,.22)}
    .toggle{display:inline-flex;align-items:center;gap:.5rem;padding:.45rem .7rem;border-radius:999px;border:1px solid rgba(255,255,255,.25);color:#fff;background:rgba(255,255,255,.06);cursor:pointer;font-weight:800;font-size:12px}
    .toggle .dot{width:9px;height:9px;border-radius:50%;background:#FFB200;box-shadow:0 0 10px #ffb20088}

    /* Layout */
    main{padding:18px;max-width:1200px;margin-inline:auto}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid-cols-3{grid-template-columns:1.2fr 1fr 1fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .head{padding:12px 14px;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border-bottom:1px solid var(--border);font-weight:900}
    .body{padding:14px}
    .muted{color:var(--muted)}
    .pill{display:inline-block;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:999px;padding:.35rem .65rem;font-size:12px;color:var(--panel-ink)}
    .list{margin:0;padding-left:1.1rem}
    .list li{margin:.3rem 0}

    /* Progress Ring */
    .progress-wrap{display:grid;grid-template-columns:150px 1fr;gap:14px;align-items:center}
    .ring{width:140px;height:140px;border-radius:50%;background:
      conic-gradient(var(--accent) calc(var(--p)*1%), rgba(255,255,255,.12) 0);
      display:grid;place-items:center;border:1px solid var(--border)}
    .ring-inner{width:108px;height:108px;border-radius:50%;display:grid;place-items:center;background:rgba(0,0,0,.15);border:1px solid var(--border)}
    .ring strong{font-size:26px}

    /* Timeline */
    .timeline{position:relative}
    .steps{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
    .step{position:relative;padding:10px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.04)}
    .step .dot{position:absolute;top:-8px;left:12px;width:14px;height:14px;border-radius:50%;background:#444;border:2px solid var(--border)}
    .step.active{outline:2px solid rgba(255,178,0,.35);background:linear-gradient(180deg, rgba(166,46,63,.20), rgba(166,46,63,.08))}
    .step.active .dot{background:var(--accent);box-shadow:0 0 0 6px rgba(255,178,0,.12)}
    .step.complete{outline:2px solid rgba(76,175,80,.35);background:linear-gradient(180deg, rgba(76,175,80,.20), rgba(76,175,80,.08))}
    .step.complete .dot{background:#4CAF50;box-shadow:0 0 0 6px rgba(76,175,80,.12)}
    .step small{display:block;color:var(--muted);margin-top:6px}
    .bar{position:absolute;left:0;right:0;top:18px;height:3px;background:rgba(255,255,255,.08)}
    .bar > span{display:block;height:100%;width:var(--bar,0%);background:linear-gradient(90deg,#A62E3F,#FFB200)}

    /* Updates table */
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:.65rem .8rem;border-bottom:1px solid var(--border);text-align:left}
    thead th{background:#191919;color:#FFB200;font-weight:900}
    tbody tr:nth-child(even) td{background:rgba(255,255,255,.03)}

    /* Preview */
    .preview{border-radius:14px;border:1px solid var(--border);overflow:hidden;background:rgba(255,255,255,.02)}
    .preview iframe{width:100%;height:420px;border:0;background:#111}

    /* Status indicators */
    .status-indicator{display:inline-flex;align-items:center;gap:6px;padding:.25rem .5rem;border-radius:6px;font-size:11px;font-weight:700}
    .status-pending{background:rgba(255,193,7,.15);color:#ffc107;border:1px solid rgba(255,193,7,.3)}
    .status-progress{background:rgba(33,150,243,.15);color:#2196f3;border:1px solid rgba(33,150,243,.3)}
    .status-complete{background:rgba(76,175,80,.15);color:#4caf50;border:1px solid rgba(76,175,80,.3)}
    .status-blocked{background:rgba(244,67,54,.15);color:#f44336;border:1px solid rgba(244,67,54,.3)}

    /* Development tracker */
    .dev-tracker{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:16px}
    .dev-tracker h4{margin:0 0 12px 0;color:var(--accent);font-size:14px}
    .dev-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.06)}
    .dev-item:last-child{border-bottom:none}
    .dev-checkbox{width:16px;height:16px;accent-color:var(--accent)}
    .dev-label{flex:1;font-size:13px}
    .dev-status{font-size:11px;opacity:.8}

    /* Success notification */
    .success{color:#22c55e}
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
  
  <!-- Firebase Client SDK (public) for login-gated access -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <!-- Firebase configuration with fallback -->
  <script>
    // Firebase configuration - will try to load from external file, fallback to embedded config
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyBW4HaQtl9Xce82dDByp_k0I1wVybgbCFQ",
      authDomain: "inex-a4b30.firebaseapp.com",
      projectId: "inex-a4b30",
      storageBucket: "inex-a4b30.firebasestorage.app",
      messagingSenderId: "111262904587",
      appId: "1:111262904587:web:7368dc9a07c8c44db20e",
      measurementId: "G-CL6M00YQJH"
    };
    
    // Try to load external config if available (for development)
    const script = document.createElement('script');
    script.src = 'firebase-config.js';
    script.onload = function() {
      if (window.FIREBASE_CONFIG_EXTERNAL) {
        window.FIREBASE_CONFIG = window.FIREBASE_CONFIG_EXTERNAL;
        console.log('External Firebase config loaded successfully');
      }
    };
    script.onerror = function() {
      console.log('Using embedded Firebase config (external file not available)');
    };
    document.head.appendChild(script);
  </script>
  <!-- INEX Unified Authentication System -->
  <script src="auth-system.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img src="inex-logo.png" alt="INEX Systems & Designs" />
      <span>INEX Project Status</span>
      <small style="opacity:.85;font-weight:700">· Public Status Page</small>
    </div>
    <div class="spacer"></div>

    <a id="themeToggle" class="toggle" href="#"><span class="dot"></span><span id="themeLabel">1.0 Light</span></a>
  </header>

  <main>
    <!-- Minimal Authentication Gate (will be inserted by JavaScript) -->

    <!-- Client Notice -->
    <div style="text-align:center;margin-bottom:20px;padding:1rem;background:linear-gradient(135deg, rgba(166,46,63,.1), rgba(255,178,0,.1));border:1px solid rgba(166,46,63,.2);border-radius:12px;max-width:800px;margin-left:auto;margin-right:auto">
      <strong>🎯 Welcome to INEX Project Status</strong><br>
      <small>This page shows the current progress of your INEX-branded operations portal development. Messages and status updates are saved via Vercel API to inex-live-data.json in real-time!</small>
    </div>

    <!-- Manual Refresh Controls -->
    <div style="text-align:center;margin-bottom:20px;padding:1rem;background:rgba(0,150,136,.1);border:1px solid rgba(0,150,136,.2);border-radius:12px;max-width:800px;margin-left:auto;margin-right:auto">
      <strong>🔄 Manual Refresh Controls</strong><br>
      <small>Click these buttons to manually refresh data when needed (automatic intervals have been disabled to prevent constant API calls)</small>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button onclick="loadLiveStatusFromJson()" class="btn secondary" style="padding:8px 16px;font-size:12px">🔄 Refresh Status</button>
        <button onclick="loadMessages()" class="btn secondary" style="padding:8px 16px;font-size:12px">📨 Refresh Messages</button>
        <button onclick="location.reload()" class="btn primary" style="padding:8px 16px;font-size:12px">🔄 Full Page Refresh</button>
      </div>
    </div>

    <section class="grid grid-cols-3">
      <!-- Overview / Progress -->
      <article class="card">
        <div class="head">Overview</div>
        <div class="body">
          <div class="progress-wrap">
            <div class="ring" style="--p:5"><div class="ring-inner"><strong id="pct">5%</strong></div></div>
            <div>
              <div style="font-weight:900;font-size:18px">Current Phase: <span id="phaseLabel">Phase 1</span></div>
              <div class="muted" id="eta">ETA: Sep 11-18, 2025 · Weekly updates posted below</div>
              <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
                <span class="pill" id="badgeScope">Scope v1.0</span>
                <span class="pill" id="badgeOwner">Owner: Cochran Full Stack Solutions</span>
                <span class="pill" id="badgeClient">Client: INEX</span>
              </div>
            </div>
          </div>
        </div>
      </article>

      <!-- Milestones -->
      <article class="card">
        <div class="head">Milestones</div>
        <div class="body">
          <ul class="list">
            <li>Phase 1: Prototype Polish — <strong>In Progress</strong> ⏳</li>
            <li>Phase 2: Auth + Connectors — <strong>Planned</strong> 📅</li>
            <li>Phase 3: Client Portal & Reports — <strong>Planned</strong> 📅</li>
            <li>Full Deployment — <strong>Planned</strong> 📅</li>
          </ul>
        </div>
      </article>

      <!-- Next actions -->
      <article class="card">
        <div class="head">Next Actions</div>
        <div class="body">
          <ul class="list" id="nextActions">
            <li>Complete INEX branding integration</li>
            <li>Finalize basic UI framework and themes</li>
            <li>Prepare core dashboard structure</li>
          </ul>
        </div>
      </article>
    </section>

    <!-- Timeline -->
    <section class="card" style="margin-top:16px">
      <div class="head">Project Timeline</div>
      <div class="body timeline">
        <div class="bar"><span id="barFill" style="--bar:5%"></span></div>
        <div class="steps" id="steps">
          <div class="step active" data-phase="Phase 1"><span class="dot"></span><strong>Phase 1</strong><small>Prototype Polish</small></div>
          <div class="step" data-phase="Phase 2"><span class="dot"></span><strong>Phase 2</strong><small>Auth + Connectors</small></div>
          <div class="step" data-phase="Phase 3"><span class="dot"></span><strong>Phase 3</strong><small>Client Portal</small></div>
        </div>
      </div>
    </section>

    <!-- Development Tracker -->
    <section class="card" style="margin-top:16px">
      <div class="head">Development Tracker</div>
      <div class="body">
        <div class="dev-tracker">
          <h4>🔄 Phase 1: Prototype Polish Items</h4>
          <div id="devItems">
            <div class="dev-item">
              <input type="checkbox" class="dev-checkbox" id="dev1" data-task="inex-branding">
              <label for="dev1" class="dev-label">INEX branding integration and color tokens</label>
              <span class="dev-status status-progress">In Progress</span>
            </div>
            <div class="dev-item">
              <input type="checkbox" class="dev-checkbox" id="dev2" data-task="ui-framework">
              <label for="dev2" class="dev-label">Basic UI framework (Dark/Light themes)</label>
              <span class="dev-status status-pending">Pending</span>
            </div>
            <div class="dev-item">
              <input type="checkbox" class="dev-checkbox" id="dev3" data-task="dashboard-structure">
              <label for="dev3" class="dev-label">Core dashboard structure and navigation</label>
              <span class="dev-status status-pending">Pending</span>
            </div>
            <div class="dev-item">
              <input type="checkbox" class="dev-checkbox" id="dev4" data-task="project-docs">
              <label for="dev4" class="dev-label">Project documentation and specs</label>
              <span class="dev-status status-pending">Pending</span>
            </div>
            <div class="dev-item">
              <input type="checkbox" class="dev-checkbox" id="dev5" data-task="deployment-prep">
              <label for="dev5" class="dev-label">Deployment preparation and testing</label>
              <span class="dev-status status-pending">Pending</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Updates -->
    <section class="grid" style="margin-top:16px">
      <article class="card">
        <div class="head">Weekly Updates</div>
        <div class="body">
          <table>
            <thead><tr><th>Date</th><th>Update</th><th>Status</th></tr></thead>
            <tbody id="updates">
              <tr><td>Jan 8</td><td>Phase 1 initiated - INEX branding integration started</td><td><span class="pill">In Progress</span></td></tr>
              <tr><td>Jan 9</td><td>Basic UI framework development</td><td><span class="pill">In Progress</span></td></tr>
              <tr><td>Jan 10</td><td>Dashboard structure planning</td><td><span class="pill">Planned</span></tr>
            </tbody>
          </table>
        </div>
      </article>

      <!-- Communication Section -->
      <article class="card">
        <div class="head">💬 Message Developer</div>
        <div class="body">
          <div style="margin-bottom:20px">
            <p style="margin:0 0 16px 0;font-size:14px;color:var(--muted);line-height:1.5">
              Send a message to the development team. Your message will be visible to both you and the developers.
            </p>
            
            <!-- GitHub Pages Notice -->
            <div id="githubPagesNotice" style="display:block;margin-bottom:16px;padding:12px;background:rgba(0,150,136,.1);border:1px solid rgba(0,150,136,.2);border-radius:8px;font-size:12px">
              <strong>✅ Vercel API Integration Active</strong><br>
              <small>Messages are automatically saved via Vercel API to inex-live-data.json. Both client and developer can respond to messages in real-time.</small>
            </div>
            
            <!-- User Info Display (shown when logged in) -->
            <div id="userInfo" style="display:none;margin-bottom:16px;padding:12px;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.2);border-radius:8px;font-size:12px">
              <div id="userInfoContent"></div>
              <button id="signOutBtn" class="btn secondary" style="display:inline-block;padding:8px 16px;font-size:12px;margin-top:8px;background:rgba(220,38,38,0.1);color:#dc2626;border:1px solid rgba(220,38,38,0.3);border-radius:6px;cursor:pointer;font-weight:600;transition:all 0.2s ease;width:auto;height:auto;opacity:1;visibility:visible;" onmouseover="this.style.background='rgba(220,38,38,0.2)'" onmouseout="this.style.background='rgba(220,38,38,0.1)'">🚪 Sign Out</button>
            </div>

            <form id="messageForm" style="display:grid;gap:16px">
              <div style="display:grid;gap:8px">
                <label for="messageName" style="font-size:12px;font-weight:600;color:var(--panel-ink);text-transform:uppercase;letter-spacing:0.5px">Your Name</label>
                <input type="text" id="messageName" placeholder="Anonymous (optional)" style="padding:12px 16px;border:2px solid var(--border);border-radius:12px;background:var(--panel);color:var(--panel-ink);font-size:14px;transition:all 0.2s ease;outline:none" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
              </div>
              
              <div style="display:grid;gap:8px">
                <label for="messageText" style="font-size:12px;font-weight:600;color:var(--panel-ink);text-transform:uppercase;letter-spacing:0.5px">Message</label>
                <textarea id="messageText" placeholder="Type your message here..." rows="4" style="padding:12px 16px;border:2px solid var(--border);border-radius:12px;background:var(--panel);color:var(--panel-ink);font-size:14px;resize:vertical;transition:all 0.2s ease;outline:none;line-height:1.5" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"></textarea>
              </div>
              
              <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0">
                <small style="color:var(--muted);font-size:12px;font-weight:500" id="charCount">0 characters</small>
                <button type="submit" class="btn primary" style="padding:12px 24px;font-size:14px;font-weight:700;border-radius:12px;box-shadow:0 4px 12px rgba(166,46,63,0.3);transition:all 0.2s ease" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(166,46,63,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(166,46,63,0.3)'">📤 Send Message</button>
              </div>
            </form>
          </div>
          
          <div style="border-top:2px solid var(--border);padding-top:20px">
            <h4 style="margin:0 0 16px 0;font-size:16px;color:var(--accent);font-weight:700;display:flex;align-items:center;gap:8px">
              <span>📨</span>
              <span>Recent Messages</span>
            </h4>
            <div id="messagesList" style="max-height:400px;overflow-y:auto;padding-right:8px">
              <div style="text-align:center;padding:40px 20px;color:var(--muted);font-size:14px;background:rgba(255,255,255,0.02);border-radius:12px;border:2px dashed var(--border)">
                <div style="font-size:24px;margin-bottom:8px">💬</div>
                <div style="font-weight:600;margin-bottom:4px">No messages yet</div>
                <div>Send the first message to get started!</div>
              </div>
            </div>
            
            <!-- Reply Form Container -->
            <div id="replyFormContainer" style="display:none;margin-top:20px;padding:20px;background:rgba(255,178,0,.05);border:1px solid rgba(255,178,0,.2);border-radius:12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                <h5 style="margin:0;color:var(--accent);font-size:14px;font-weight:600">💬 Reply to: <span id="replyToName"></span></h5>
                <button class="btn secondary" style="padding:4px 8px;font-size:11px" onclick="hideReplyForm()">✕ Close</button>
              </div>
              <div style="display:grid;gap:12px">
                <div>
                  <label style="font-size:12px;font-weight:600;color:var(--panel-ink);text-transform:uppercase;letter-spacing:0.5px">YOUR RESPONSE</label>
                  <textarea id="replyText" placeholder="Type your response here..." rows="3" style="width:100%;padding:12px 16px;border:2px solid var(--border);border-radius:12px;background:var(--panel);color:var(--panel-ink);font-size:14px;resize:vertical;transition:all 0.2s ease;outline:none;line-height:1.5" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"></textarea>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <small style="color:var(--muted);font-size:12px" id="replyCharCount">0 characters</small>
                  <button class="btn primary" style="padding:8px 16px;font-size:13px;font-weight:600" onclick="submitReply()">📤 Send Response</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </article>
    </section>

    <p class="muted" style="text-align:center;margin:20px 0">Shareable link • Add query params like <code>?progress=25&phase=Phase 2</code> to reflect live status.</p>
    <div style="text-align:center;margin:20px 0;padding:1rem;background:rgba(166,46,63,.1);border:1px solid rgba(166,46,63,.2);border-radius:8px;max-width:800px;margin-left:auto;margin-right:auto">
      <strong>📋 Project Scope</strong><br>
      <small>INEX-branded Operations Portal: Dashboard, Jobs/Dispatch, Inventory, RMA/Warranties, SLAs/Reports, Knowledge, Clients, Careers, Settings. Dark/Light themes with SVG charts and mock data layer.</small>
    </div>
    <div style="text-align:center;margin:20px 0;padding:1rem;background:rgba(0,150,136,.1);border:1px solid rgba(0,150,136,.2);border-radius:8px;max-width:600px;margin-left:auto;margin-right:auto">
      <strong>🔄 Real-Time Updates</strong><br>
      <small>This page automatically updates when changes are made in the management dashboard. Messages and status updates are saved via Vercel API to inex-live-data.json in real-time!</small>
    </div>
  </main>

  <script>
    // Error handling and logging configuration
    const CONFIG = {
      enableSentry: false, // Disable Sentry to prevent 429 errors
      enableConsoleLogs: true,
      autoRefreshInterval: 30000,
      maxRetries: 3
    };

    // INEX Unified Authentication System Integration
    // The auth-system.js handles all Firebase authentication automatically
    
    // Minimal inline email/password gate (for Cody + Zeb testing)
    // If you have created accounts in Firebase Auth, this will allow immediate sign-in.
    async function ensureTestAuthGate(){
      try{
        // Use the unified auth system
        if (window.inexAuth && window.inexAuth.isAuthenticated()) return; // already signed in & allowed
        
        // Don't create if already exists
        if (document.getElementById('authGate')) return;
        
        // Create a lightweight banner with email+password inputs
        const main = document.querySelector('main');
        if (!main) return;
        
        const gate = document.createElement('div');
        gate.id = 'authGate';
        gate.style.cssText = 'background:rgba(255,178,0,.08);border:2px solid #FFB200;border-radius:12px;padding:12px 16px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:16px;box-shadow:0 4px 12px rgba(255,178,0,.15);justify-content:center;text-align:center';
        gate.innerHTML = `
          <span style="color:#FFB200;font-weight:800;font-size:14px;">🔐 Restricted Access - Sign In Required</span>
          <input id="authEmail" placeholder="Email" style="max-width:240px;padding:8px 12px;border:1px solid #FFB200;border-radius:6px;background:white;color:black">
          <input id="authPass" placeholder="Password" type="password" style="max-width:180px;padding:8px 12px;border:1px solid #FFB200;border-radius:6px;background:white;color:black">
          <button id="authLoginBtn" style="background:#FFB200;color:black;border:none;padding:8px 16px;border-radius:6px;font-weight:600;cursor:pointer"><i class="fa-solid fa-right-to-bracket"></i> Sign In</button>
          <span id="authStatus" style="margin-left:6px;color:#666;font-size:12px"></span>
        `;
        
        // Insert at the top of main content
        main.insertBefore(gate, main.firstChild);
        
        const status = gate.querySelector('#authStatus');
        gate.querySelector('#authLoginBtn').addEventListener('click', async ()=>{
          const e = gate.querySelector('#authEmail').value.trim();
          const p = gate.querySelector('#authPass').value;
          if (!e) { status.textContent = 'Enter your email'; return; }
          if (!p) { status.textContent = 'Enter password'; return; }
          
          try{
            status.textContent = 'Signing in…';
            await window.inexAuth.signIn(e, p);
            status.textContent = 'Signed in';
            gate.style.display = 'none';
          }catch(err){
            status.textContent = 'Sign-in failed: ' + err.message;
            console.warn('auth error', err?.message);
          }
        });
        
        console.log('✅ Auth gate created and inserted');
      }catch(err){ 
        console.error('Failed to create auth gate:', err);
      }
    }
    
    // Update authentication UI based on user state
    function updateAuthUI() {
      const userInfo = document.getElementById('userInfo');
      const messageForm = document.getElementById('messageForm');
      const userInfoContent = document.getElementById('userInfoContent');
      const signOutBtn = document.getElementById('signOutBtn');
      const authGate = document.getElementById('authGate');

      console.log('🔍 updateAuthUI called with elements:', {
        userInfo: !!userInfo,
        messageForm: !!messageForm,
        userInfoContent: !!userInfoContent,
        signOutBtn: !!signOutBtn,
        authGate: !!authGate,
        isAuthenticated: window.inexAuth?.isAuthenticated()
      });

      if (window.inexAuth && window.inexAuth.isAuthenticated()) {
        const user = window.inexAuth.getCurrentUser();
        console.log('👤 User authenticated:', user?.email);
        
        // User is signed in
        if (authGate) authGate.style.display = 'none';
        if (userInfo) {
          userInfo.style.display = 'block';
          if (userInfoContent) {
            userInfoContent.innerHTML = `
              <strong>👤 Signed in as: ${user.email}</strong><br>
              <small>You have access to all status page features.</small>
            `;
          }
        }
        if (signOutBtn) {
          signOutBtn.style.display = 'inline-block';
          console.log('✅ Sign out button should now be visible in status.html');
        } else {
          console.log('❌ Sign out button element not found!');
        }
        if (messageForm) messageForm.style.display = 'grid';
      } else {
        // User is signed out
        if (authGate) authGate.style.display = 'block';
        if (userInfo) userInfo.style.display = 'none';
        if (signOutBtn) signOutBtn.style.display = 'none';
        if (messageForm) messageForm.style.display = 'grid';
      }
    }



    // Handle sign out using the unified system
    async function handleSignOut() {
      try {
        console.log('Sign out button clicked');
        await window.inexAuth.signOut();
        console.log('User signed out successfully');
      } catch (error) {
        console.error('Sign out error:', error);
      }
    }

    // Safe console logging
    const safeLog = (level, ...args) => {
      if (CONFIG.enableConsoleLogs && console[level]) {
        try {
          console[level](...args);
        } catch (e) {
          // Silently fail if console logging fails
        }
      }
    };

    // Safe fetch with retry logic
    async function safeFetch(url, options = {}, retries = CONFIG.maxRetries) {
      try {
        // Create timeout signal with fallback for older browsers
        let signal = null;
        if (AbortSignal.timeout) {
          signal = AbortSignal.timeout(10000); // 10 second timeout
        } else {
          // Fallback for older browsers
          const controller = new AbortController();
          setTimeout(() => controller.abort(), 10000);
          signal = controller.signal;
        }
        
        const response = await fetch(url, { 
          ...options, 
          cache: 'no-store',
          signal: signal
        });
        return response;
      } catch (error) {
        if (retries > 0 && error.name !== 'AbortError') {
          safeLog('warn', `Fetch failed, retrying... (${retries} attempts left)`);
          await new Promise(resolve => setTimeout(resolve, 1000));
          return safeFetch(url, options, retries - 1);
        }
        throw error;
      }
    }

    // Load live status from consolidated JSON file
    async function loadLiveStatusFromJson() {
      try {
        const response = await safeFetch('/inex-live-data.json');
        if (!response.ok) return;
        const data = await response.json();
        
        // Extract all data from consolidated JSON
        const pct = typeof data.progress === 'number' ? data.progress : 5;
        const phase = data.phase || 'Phase 1';
        const phaseName = data.phaseName || 'Prototype Polish';
        const eta = data.eta || 'Sep 11-18, 2025';
        const scope = data.scope || 'Scope v1.0';
        const owner = data.owner || 'Cochran Full Stack Solutions';
        const client = data.client || 'INEX';
        const nextActions = data.nextActions || [];
        const updates = data.updates || [];
        const phases = data.phases || [];

        // Update progress and phase displays
        document.querySelector('.ring').style.setProperty('--p', pct);
        document.getElementById('pct').textContent = pct + '%';
        document.getElementById('phaseLabel').textContent = phaseName || phase;
        document.getElementById('barFill').style.setProperty('--bar', pct + '%');
        document.getElementById('eta').textContent = eta;
        document.getElementById('badgeScope').textContent = scope;
        document.getElementById('badgeOwner').textContent = 'Owner: ' + owner;
        document.getElementById('badgeClient').textContent = 'Client: ' + client;

        // Update next actions
        const nextActionsList = document.getElementById('nextActions');
        if (nextActionsList && nextActions.length > 0) {
          nextActionsList.innerHTML = nextActions.map(action => `<li>${action}</li>`).join('');
        }

        // Update timeline steps
        updateTimelineSteps(phases, phase);

        // Update development tracker
        updateDevelopmentTracker(phases);

        // Update updates table
        updateUpdatesTable(updates);

        safeLog('debug', '✅ Consolidated JSON data loaded successfully');
      } catch (error) {
        safeLog('debug', 'Consolidated JSON load failed, using fallback:', error.message);
        // Silent fallback to localStorage values
      }
    }
    // Project tracking data - Phase 1: Prototype Polish (fallback data)
    const projectData = {
      currentPhase: 'Phase 1',
      progress: 5,
      phases: [
        { name: 'Phase 1', progress: 5, status: 'active', tasks: ['inex-branding', 'ui-framework', 'dashboard-structure', 'project-docs', 'deployment-prep'] },
        { name: 'Phase 2', progress: 0, status: 'pending', tasks: ['authentication', 'data-connectors', 'integration'] },
        { name: 'Phase 3', progress: 0, status: 'pending', tasks: ['client-portal', 'reporting', 'deployment'] }
      ],
      updates: [
        { date: 'Jan 8', update: 'Phase 1 initiated - INEX branding integration started', status: 'In Progress' },
        { date: 'Jan 9', update: 'Basic UI framework development', status: 'In Progress' },
        { date: 'Jan 10', update: 'Dashboard structure planning', status: 'Planned' }
      ],
      nextActions: [
        'Complete INEX branding integration',
        'Finalize basic UI framework and themes',
        'Prepare core dashboard structure'
      ]
    };

    // Initialize localStorage with default values if none exist (fallback only)
    if (!localStorage.getItem('inex-project-progress')) {
      localStorage.setItem('inex-project-progress', '5');
    }
    if (!localStorage.getItem('inex-project-phase')) {
      localStorage.setItem('inex-project-phase', 'Phase 1');
    }
    if (!localStorage.getItem('inex-project-status')) {
      localStorage.setItem('inex-project-status', 'Phase 1 (Prototype Polish) in progress. Working on INEX branding integration and basic UI framework. On track for Aug 22 completion.');
    }

    // Theme persistence
    const root = document.documentElement;
    const btn = document.getElementById('themeToggle');
    const label = document.getElementById('themeLabel');
    const saved = localStorage.getItem('inex-status-theme');
    if(saved){ root.setAttribute('data-theme', saved); label.textContent = saved === 'dark' ? '1.0 Light' : '2.0 Dark'; }
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      localStorage.setItem('inex-status-theme', next);
      label.textContent = next === 'dark' ? '1.0 Light' : '2.0 Dark';
    });

    // Query params: progress (0-100), phase, eta, scope, owner, client
    const params = new URLSearchParams(location.search);
    
    // Read from localStorage (updated by management dashboard) or fall back to query params
    const savedProgress = localStorage.getItem('inex-project-progress') || '5';
    const savedPhase = localStorage.getItem('inex-project-phase') || 'Phase 1';
    const savedStatusValue = localStorage.getItem('inex-project-status') || 'Phase 1 (Prototype Polish) in progress. Working on INEX branding integration and basic UI framework. On track for Aug 22 completion.';
    
    // Initial values (will be overridden by JSON data)
    const pct = Math.max(0, Math.min(100, parseInt(params.get('progress') || savedProgress || '5', 10)));
    const phase = params.get('phase') || savedPhase || 'Phase 1';
    const eta = params.get('eta') || 'Sep 11-18, 2025';
    const scope = params.get('scope') || 'Scope v1.0';
    const owner = params.get('owner') || 'Cochran Full Stack Solutions';
    const client = params.get('client') || 'INEX';

    // Apply to UI
    document.querySelector('.ring').style.setProperty('--p', pct);
    document.getElementById('pct').textContent = pct + '%';
    document.getElementById('phaseLabel').textContent = phase;
    document.getElementById('eta').textContent = eta;
    document.getElementById('badgeScope').textContent = scope;
    document.getElementById('badgeOwner').textContent = 'Owner: ' + owner;
    document.getElementById('badgeClient').textContent = 'Client: ' + client;
    document.getElementById('barFill').style.setProperty('--bar', pct + '%');

    // Override from live JSON if available, and refresh periodically
    loadLiveStatusFromJson();
    
    // Remove automatic interval - only refresh when user takes action
    // const liveStatusInterval = setInterval(() => {
    //   try {
    //     loadLiveStatusFromJson();
    //   } catch (error) {
    //     safeLog('warn', 'Live status refresh failed:', error.message);
    //   }
    // }, CONFIG.autoRefreshInterval);

    // Helper function to update timeline steps
    function updateTimelineSteps(phases, currentPhase) {
      const steps = Array.from(document.querySelectorAll('.step'));
      steps.forEach(s => {
        const stepPhase = s.dataset.phase;
        
        s.classList.remove('active', 'complete');
        
        if (stepPhase === currentPhase) {
          s.classList.add('active');
        } else if (phases.find(p => p.name === stepPhase)?.status === 'complete') {
          s.classList.add('complete');
        }
      });
    }

    // Helper function to update development tracker
    function updateDevelopmentTracker(phases) {
      const phase1 = phases.find(p => p.name === 'Phase 1');
      if (phase1 && phase1.tasks) {
        const devItems = document.getElementById('devItems');
        if (devItems) {
          devItems.innerHTML = phase1.tasks.map(task => `
            <div class="dev-item">
              <input type="checkbox" class="dev-checkbox" id="dev-${task.id}" data-task="${task.id}" ${task.status === 'complete' ? 'checked' : ''}>
              <label for="dev-${task.id}" class="dev-label">${task.name}</label>
              <span class="dev-status status-${task.status === 'complete' ? 'complete' : task.status === 'in-progress' ? 'progress' : 'pending'}">${task.status === 'complete' ? 'Complete' : task.status === 'in-progress' ? 'In Progress' : 'Pending'}</span>
            </div>
          `).join('');
          
          // Reattach event listeners
          attachDevTrackerListeners();
        }
      }
    }

    // Helper function to update updates table
    function updateUpdatesTable(updates) {
      const updatesTable = document.getElementById('updates');
      if (updatesTable && updates.length > 0) {
        updatesTable.innerHTML = updates.map(update => `
          <tr>
            <td>${update.date}</td>
            <td>${update.update}</td>
            <td><span class="pill">${update.status}</span></td>
          </tr>
        `).join('');
      }
    }

    // Helper function to attach dev tracker event listeners
    function attachDevTrackerListeners() {
      const devCheckboxes = document.querySelectorAll('.dev-checkbox');
      devCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const task = this.dataset.task;
          const status = this.checked ? 'complete' : 'pending';
          
          // Update progress based on completed tasks
          updateProgress();
          
          // Save to localStorage
          localStorage.setItem(`inex-dev-${task}`, status);
        });
      });
    }

    // Mark active step (initial load - will be updated by JSON data)
    const steps = Array.from(document.querySelectorAll('.step'));
    steps.forEach(s => {
      const stepPhase = s.dataset.phase;
      const currentPhase = phase;
      
      s.classList.remove('active', 'complete');
      
      if (stepPhase === currentPhase) {
        s.classList.add('active');
      } else if (projectData.phases.find(p => p.name === stepPhase)?.status === 'complete') {
        s.classList.add('complete');
      }
    });

    // Development tracker functionality (initial setup - will be updated by JSON data)
    const devCheckboxes = document.querySelectorAll('.dev-checkbox');
    devCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const task = this.dataset.task;
        const status = this.checked ? 'complete' : 'pending';
        
        // Update progress based on completed tasks
        updateProgress();
        
        // Save to localStorage
        localStorage.setItem(`inex-dev-${task}`, status);
      });
      
      // Load saved state
      const savedDevStatus = localStorage.getItem(`inex-dev-${checkbox.dataset.task}`);
      if (savedDevStatus === 'complete') {
        checkbox.checked = true;
      }
    });

    function updateProgress() {
      const totalTasks = devCheckboxes.length;
      const completedTasks = Array.from(devCheckboxes).filter(cb => cb.checked).length;
      const newProgress = Math.round((completedTasks / totalTasks) * 100);
      
      // Update progress ring and bar
      document.querySelector('.ring').style.setProperty('--p', newProgress);
      document.getElementById('pct').textContent = newProgress + '%';
      document.getElementById('barFill').style.setProperty('--bar', newProgress + '%');
      
      // Update project data
      projectData.progress = newProgress;
      
      // Save progress to localStorage
      localStorage.setItem('inex-project-progress', newProgress);
    }

    // Auto-save progress every 30 seconds - REMOVED to prevent constant API calls
    // const autoSaveInterval = setInterval(() => {
    //   try {
    //     localStorage.setItem('inex-data', JSON.stringify(projectData));
    //   } catch (error) {
    //     safeLog('warn', 'Failed to save progress data:', error.message);
    //   }
    // }, CONFIG.autoRefreshInterval);

    // Listen for localStorage changes to update the page in real-time
    window.addEventListener('storage', function(e) {
      if (e.key === 'inex-project-progress') {
        const progress = parseInt(e.newValue || '5');
        document.querySelector('.ring').style.setProperty('--p', progress);
        document.getElementById('pct').textContent = progress + '%';
        document.getElementById('barFill').style.setProperty('--bar', progress + '%');
        
        // Update project data
        projectData.progress = progress;
      }
      if (e.key === 'inex-project-phase') {
        const phase = e.newValue || 'Phase 1';
        document.getElementById('phaseLabel').textContent = phase;
        
        // Update project data
        projectData.currentPhase = phase;
        
        // Update active step
        const steps = Array.from(document.querySelectorAll('.step'));
        steps.forEach(s => {
          const stepPhase = s.dataset.phase;
          const currentPhase = phase;
          
          s.classList.remove('active', 'complete');
          
          if (stepPhase === currentPhase) {
            s.classList.add('active');
          } else if (projectData.phases.find(p => p.name === stepPhase)?.status === 'complete') {
            s.classList.add('complete');
          }
        });
      }
      if (e.key === 'inex-project-status') {
        // Status updates could be displayed somewhere if needed
        safeLog('debug', 'Status updated:', e.newValue);
      }
      if (e.key === 'inex-project-updates') {
        try {
          const updates = JSON.parse(e.newValue || '[]');
          const updatesTable = document.getElementById('updates');
          updatesTable.innerHTML = '';
          
          updates.forEach(update => {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
              <td>${update.date}</td>
              <td>${update.update}</td>
              <td><span class="pill">${update.status}</span></td>
            `;
            updatesTable.appendChild(newRow);
          });
          
          // Update project data
          projectData.updates = updates;
        } catch (e) {
          safeLog('warn', 'Error parsing updates');
        }
      }
    });

    // Load saved progress on page load (already loaded above, just update projectData)
    if (savedProgress) {
      projectData.progress = parseInt(savedProgress);
    } else {
      // Set default progress if none saved
      projectData.progress = 5;
    }

    // Load saved updates from localStorage
    const savedUpdates = localStorage.getItem('inex-project-updates');
    if (savedUpdates) {
      try {
        const updates = JSON.parse(savedUpdates);
        const updatesTable = document.getElementById('updates');
        updatesTable.innerHTML = ''; // Clear existing updates
        
        updates.forEach(update => {
          const newRow = document.createElement('tr');
          newRow.innerHTML = `
            <td>${update.date}</td>
            <td>${update.update}</td>
            <td><span class="pill">${update.status}</span></td>
          `;
          updatesTable.appendChild(newRow);
        });
        
        // Update project data
        projectData.updates = updates;
      } catch (e) {
        safeLog('debug', 'No saved updates found');
      }
    }

    // Load saved status from localStorage (already loaded above)
    // savedStatusValue is available from the earlier declaration

    // Add update functionality
    function addUpdate(date, update, status) {
      const updatesTable = document.getElementById('updates');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td>${date}</td>
        <td>${update}</td>
        <td><span class="pill">${status}</span></td>
      `;
      updatesTable.appendChild(newRow);
      
      // Save to project data
      projectData.updates.push({ date, update, status });
    }

    // Example: Add a new update (you can call this from console or add a form)
    // addUpdate('Dec 18', 'Requirements document drafted', 'Complete');

    // Messaging System - Global API Integration
    const messageForm = document.getElementById('messageForm');
    const messagesList = document.getElementById('messagesList');
    const messageText = document.getElementById('messageText');
    const charCount = document.getElementById('charCount');
    const githubPagesNotice = document.getElementById('githubPagesNotice');

    // API endpoint for messages - detect development vs production
    const isDev = window.location.hostname === 'localhost' || 
                  window.location.hostname === '127.0.0.1' ||
                  window.location.port !== '' ||
                  window.location.protocol === 'file:';
    
    const API_BASE = isDev ? 'http://localhost:3000' : 'https://inex.cochranfilms.com';
    const MESSAGES_API = `${API_BASE}/api/messages`;
    const STATUS_API = `${API_BASE}/api/status-update`;
    
    // For live site, we'll use Vercel API endpoints
    const isLiveSite = !isDev && window.location.hostname === 'inex.cochranfilms.com';

    // Debug logging for API configuration
    safeLog('debug', '🔍 Status Page API Configuration:');
    safeLog('debug', '  Hostname:', window.location.hostname);
    safeLog('debug', '  Port:', window.location.port);
    safeLog('debug', '  Protocol:', window.location.protocol);
    safeLog('debug', '  Origin:', window.location.origin);
    safeLog('debug', '  isDev:', isDev);
    safeLog('debug', '  API_BASE:', API_BASE);
    safeLog('debug', '  MESSAGES_API:', MESSAGES_API);

    // Update character count
    messageText.addEventListener('input', function() {
      const textLength = this.value.length;
      charCount.textContent = `${textLength} characters`;
    });

    // Load messages from consolidated JSON file
    async function loadMessages() {
      try {
        // Always try to load from JSON file first for immediate display
        safeLog('debug', 'Loading messages from JSON file...');
        const jsonResponse = await safeFetch('inex-live-data.json');
        if (jsonResponse.ok) {
          const liveData = await jsonResponse.json();
          const messages = liveData.messages || [];
          displayMessages(messages);
          localStorage.setItem('inex-messages', JSON.stringify(messages));
          safeLog('debug', `✅ Loaded ${messages.length} messages from JSON file`);
          return;
        }
        
        // If JSON fails, try API endpoint as fallback
        if (!isLiveSite) {
          safeLog('debug', 'JSON failed, trying API endpoint...');
          const response = await safeFetch(MESSAGES_API);
          
          if (response.ok) {
            const data = await response.json();
            const messages = data.messages || [];
            displayMessages(messages);
            
            // Save to localStorage as backup
            localStorage.setItem('inex-messages', JSON.stringify(messages));
            safeLog('debug', `✅ Loaded ${messages.length} messages from API`);
            return;
          }
        }
        
        // Final fallback to localStorage
        safeLog('warn', 'All remote sources failed, using localStorage fallback');
        loadMessagesFromLocalStorage();
        
      } catch (error) {
        safeLog('warn', 'Failed to load messages, using localStorage fallback:', error.message);
        loadMessagesFromLocalStorage();
      }
    }

    // Fallback to localStorage
    function loadMessagesFromLocalStorage() {
      const savedMessages = localStorage.getItem('inex-messages') || '[]';
      const messages = JSON.parse(savedMessages);
      displayMessages(messages);
    }

    // Display messages with enhanced design
    function displayMessages(messages) {
      if (messages.length === 0) {
        messagesList.innerHTML = `
          <div style="text-align:center;padding:40px 20px;color:var(--muted);font-size:14px;background:rgba(255,255,255,0.02);border-radius:12px;border:2px dashed var(--border)">
            <div style="font-size:24px;margin-bottom:8px">💬</div>
            <div style="font-weight:600;margin-bottom:4px">No messages yet</div>
            <div>Send the first message to get started!</div>
          </div>
        `;
        return;
      }

      messagesList.innerHTML = messages.map(msg => `
        <div style="
          padding: 20px;
          border: 1px solid var(--border);
          border-radius: 16px;
          margin-bottom: 16px;
          background: rgba(255,255,255,.04);
          box-shadow: 0 4px 16px rgba(0,0,0,.08);
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
        " onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(0,0,0,.12)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 16px rgba(0,0,0,.08)'">
          
          <!-- Priority indicator bar -->
          ${msg.priority && msg.priority !== 'normal' ? `
            <div style="
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              height: 4px;
              background: ${msg.priority === 'urgent' ? 'linear-gradient(90deg, #f44336, #ff5722)' : 
                           msg.priority === 'high' ? 'linear-gradient(90deg, #ff9800, #ffc107)' :
                           'linear-gradient(90deg, #4caf50, #8bc34a)'};
            "></div>
          ` : ''}
          
          <!-- Message header -->
          <div style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
          ">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: linear-gradient(135deg, var(--accent), var(--maroon));
                display: grid;
                place-items: center;
                color: white;
                font-weight: 700;
                font-size: 16px;
                box-shadow: 0 2px 8px rgba(255,178,0,0.3);
              ">${(msg.name || 'A').charAt(0).toUpperCase()}</div>
              <div>
                <strong style="
                  font-size: 16px;
                  color: var(--panel-ink);
                  font-weight: 700;
                  display: block;
                ">${msg.name || 'Anonymous'}</strong>
                ${msg.email ? `<small style="color: var(--muted); font-size: 12px;">${msg.email}</small>` : ''}
              </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 8px;">
              ${msg.priority && msg.priority !== 'normal' ? `
                <span style="
                  padding: 4px 12px;
                  border-radius: 20px;
                  font-size: 11px;
                  font-weight: 700;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  ${msg.priority === 'urgent' ? 'background: rgba(244,67,54,.15); color: #f44336; border: 1px solid rgba(244,67,54,.3);' : 
                    msg.priority === 'high' ? 'background: rgba(255,152,0,.15); color: #ff9800; border: 1px solid rgba(255,152,0,.3);' :
                    'background: rgba(76,175,80,.15); color: #4caf50; border: 1px solid rgba(76,175,80,.3);'}
                ">${msg.priority}</span>
              ` : ''}
              <small style="
                color: var(--muted);
                font-size: 12px;
                background: rgba(255,255,255,.08);
                padding: 6px 10px;
                border-radius: 8px;
                font-weight: 500;
                white-space: nowrap;
              ">${formatTimestamp(msg.timestamp)}</small>
            </div>
          </div>
          
          <!-- Message content -->
          <div style="
            font-size: 14px;
            line-height: 1.6;
            color: var(--panel-ink);
            margin-bottom: 16px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            padding: 16px;
            background: rgba(255,255,255,.02);
            border-radius: 12px;
            border-left: 4px solid var(--accent);
          ">${msg.text}</div>
          
          <!-- Responses -->
          ${msg.responses && msg.responses.length > 0 ? `
            <div style="
              margin-top: 16px;
              padding: 16px;
              background: linear-gradient(135deg, rgba(166,46,63,.08), rgba(255,178,0,.08));
              border: 1px solid rgba(166,46,63,.15);
              border-radius: 12px;
              position: relative;
            ">
              <div style="
                position: absolute;
                top: -8px;
                left: 16px;
                background: var(--panel);
                padding: 0 8px;
                font-size: 11px;
                font-weight: 700;
                color: var(--accent);
                text-transform: uppercase;
                letter-spacing: 0.5px;
              ">Response</div>
              <div style="
                font-size: 13px;
                line-height: 1.5;
                color: var(--panel-ink);
                font-style: italic;
              ">${msg.responses[msg.responses.length - 1].text}</div>
              <div style="
                margin-top: 8px;
                font-size: 11px;
                color: var(--muted);
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <span>👤</span>
                <span>${msg.responses[msg.responses.length - 1].responder || 'Development Team'}</span>
                <span>•</span>
                <span>${formatTimestamp(msg.responses[msg.responses.length - 1].timestamp)}</span>
              </div>
            </div>
          ` : ''}
          
          <!-- Status indicators -->
          <div style="
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
          ">
            <span style="
              display: flex;
              align-items: center;
              gap: 6px;
              font-size: 12px;
              color: var(--muted);
            ">
              <span style="
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: ${msg.read ? '#4caf50' : '#ff9800'};
              "></span>
              ${msg.read ? 'Read' : 'Unread'}
            </span>
            <span style="
              display: flex;
              align-items: center;
              gap: 6px;
              font-size: 12px;
              color: var(--muted);
            ">
              <span style="
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: ${msg.responded ? '#4caf50' : '#f44336'};
              "></span>
              ${msg.responded ? 'Responded' : 'No Response'}
            </span>
          </div>
          
          <!-- Action buttons -->
          <div style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
          ">
            <div style="display: flex; gap: 8px;">
              ${!msg.read ? `<button class="btn secondary" style="padding:6px 12px;font-size:12px" onclick="markMessageAsRead('${msg.id}')">✓ Mark Read</button>` : ''}
              ${!msg.responded ? `<button class="btn primary" style="padding:6px 12px;font-size:12px" onclick="showReplyForm('${msg.id}', '${msg.name}')">💬 Reply</button>` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    // Handle message form submission
    messageForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Check if user is authenticated
      if (!currentUser) {
        alert('Please sign in to send messages');
        return;
      }
      
      const nameInput = document.getElementById('messageName');
      const textInput = document.getElementById('messageText');
      
      // Use Firebase user info if available, fallback to input
      const name = currentUser.displayName || 
                   currentUser.email.split('@')[0] || 
                   nameInput.value.trim() || 
                   'Anonymous';
      const text = textInput.value.trim();
      
      if (!text) {
        alert('Please enter a message');
        return;
      }

      // Show loading state
      const submitBtn = messageForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '📤 Sending...';
      submitBtn.disabled = true;

      try {
        if (isLiveSite) {
          // For live site, use Vercel API to save message
          safeLog('debug', 'Sending message via Vercel API on live site');
          const response = await safeFetch(MESSAGES_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: name,
              text: text,
              email: currentUser.email, // Include user's email from Firebase
              priority: 'normal',
              category: 'client-feedback'
            })
          });

          if (response.ok) {
            // API success - message saved to JSON file
            const result = await response.json();
            safeLog('debug', '✅ Message sent successfully via Vercel API:', result);
            
            // Reload messages to show the new one
            await loadMessages();
            
            // Show success message
            showMessageSuccess('Message sent successfully! It has been saved and will appear on this page immediately.');
            
            // Reset form
            textInput.value = '';
            charCount.textContent = '0 characters';
            
          } else {
            // API failed - try to get error details
            let errorMessage = 'Failed to send message';
            try {
              const errorData = await response.json();
              errorMessage = errorData.error || errorMessage;
            } catch (e) {
              // Ignore JSON parse errors
            }
            
            throw new Error(`API Error: ${errorMessage}`);
          }
        } else {
          // For development, try the API endpoint first for automatic GitHub push
          safeLog('debug', 'Sending message via API for automatic GitHub push');
          const response = await safeFetch(MESSAGES_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: name,
              text: text,
              email: currentUser.email, // Include user's email from Firebase
              priority: 'normal',
              category: 'client-feedback'
            })
          });

          if (response.ok) {
            // API success - message automatically pushed to GitHub
            const result = await response.json();
            safeLog('debug', '✅ Message sent successfully via API:', result);
            
            // Reload messages to show the new one
            await loadMessages();
            
            // Show success message
            showMessageSuccess('Message sent successfully! It has been automatically pushed to GitHub and will appear on this page immediately.');
            
            // Reset form
            textInput.value = '';
            charCount.textContent = '0 characters';
            
          } else {
            // API failed - try to get error details
            let errorMessage = 'Failed to send message';
            try {
              const errorData = await response.json();
              errorMessage = errorData.error || errorMessage;
            } catch (e) {
              // Ignore JSON parse errors
            }
            
            throw new Error(`API Error: ${errorMessage}`);
          }
        }
        
      } catch (error) {
        safeLog('error', 'Failed to send message via API:', error.message);
        
        // Fallback to localStorage if API completely fails
        const message = {
          name: name,
          text: text,
          email: currentUser.email, // Include user's email from Firebase
          timestamp: new Date().toISOString(),
          id: Date.now(),
          priority: 'normal',
          category: 'client-feedback',
          status: 'new',
          read: false,
          responded: false
        };

        const savedMessages = localStorage.getItem('inex-messages') || '[]';
        const messages = JSON.parse(savedMessages);
        messages.unshift(message);
        
        localStorage.setItem('inex-messages', JSON.stringify(messages));
        displayMessages(messages);
        
        showMessageSuccess('Message saved locally (API unavailable). Please try again later.');
      }

      // Reset button
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    });

    // Show success message
    function showMessageSuccess(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; background: var(--success); color: white;
        padding: 12px 16px; border-radius: 8px; z-index: 1000; font-weight: 600;
        animation: slideIn 0.3s ease-out;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => notification.remove(), 4000);
    }

    // Format timestamp
    function formatTimestamp(timestamp) {
      if (!timestamp) return 'Just now';
      
      try {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        return date.toLocaleDateString();
      } catch (e) {
        return timestamp; // Return original if parsing fails
      }
    }

    // Listen for new messages from other windows
    window.addEventListener('storage', function(e) {
      if (e.key === 'inex-messages') {
        try {
          const messages = JSON.parse(e.newValue || '[]');
          displayMessages(messages);
        } catch (e) {
          safeLog('warn', 'Error parsing messages');
        }
      }
    });

    // Load messages on page load
    loadMessages();

    // Auto-refresh messages every 30 seconds - REMOVED to prevent constant API calls
    // const messagesInterval = setInterval(() => {
    //   try {
    //     loadMessages();
    //   } catch (error) {
    //     safeLog('warn', 'Messages refresh failed:', error.message);
    //   }
    // }, CONFIG.autoRefreshInterval);

    // Toggle GitHub Pages notice visibility
    if (!isDev) {
      githubPagesNotice.style.display = 'block';
    } else {
      githubPagesNotice.style.display = 'none';
    }

    // Reply functionality
    function showReplyForm(messageId, messageName) {
      document.getElementById('replyToName').textContent = messageName || 'Anonymous';
      document.getElementById('replyFormContainer').style.display = 'block';
      document.getElementById('replyText').value = ''; // Clear previous response
      document.getElementById('replyText').focus();
      document.getElementById('replyCharCount').textContent = '0 characters';
      
      // Store the message ID for the reply
      window.currentReplyMessageId = messageId;
      
      // Add character count functionality
      const replyText = document.getElementById('replyText');
      const replyCharCount = document.getElementById('replyCharCount');
      
      replyText.addEventListener('input', function() {
        const textLength = this.value.length;
        replyCharCount.textContent = `${textLength} characters`;
      });
    }

    function hideReplyForm() {
      document.getElementById('replyFormContainer').style.display = 'none';
      window.currentReplyMessageId = null;
    }

    async function submitReply() {
      const messageId = window.currentReplyMessageId;
      const responseText = document.getElementById('replyText').value.trim();
      
      if (!responseText) {
        alert('Please enter a response');
        return;
      }
      
      if (!messageId) {
        alert('No message selected for reply');
        return;
      }
      
      try {
        // Show loading state
        const submitBtn = document.querySelector('#replyFormContainer button[onclick="submitReply()"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '📤 Sending...';
        submitBtn.disabled = true;
        
        // Send reply via API
        const response = await safeFetch(MESSAGES_API, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messageId: messageId,
            action: 'addResponse',
            responseText: responseText,
            responder: 'Development Team'
          })
        });
        
        if (response.ok) {
          // Hide reply form
          hideReplyForm();
          
          // Reload messages to show the response
          await loadMessages();
          
          // Show success message
          showMessageSuccess('Response sent successfully!');
        } else {
          throw new Error('API request failed');
        }
      } catch (error) {
        console.warn('API failed:', error.message);
        alert('❌ Could not send response. Please try again later.');
      } finally {
        // Reset button state
        const submitBtn = document.querySelector('#replyFormContainer button[onclick="submitReply()"]');
        submitBtn.innerHTML = '📤 Send Response';
        submitBtn.disabled = false;
      }
    }

    // Mark message as read
    async function markMessageAsRead(messageId) {
      try {
        const response = await safeFetch(MESSAGES_API, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messageId: messageId,
            action: 'markRead'
          })
        });
        
        if (response.ok) {
          // Reload messages to show updated status
          await loadMessages();
          console.log('✅ Message marked as read');
        } else {
          throw new Error('API request failed');
        }
      } catch (error) {
        console.warn('API failed:', error.message);
        alert('❌ Could not mark message as read. Please try again later.');
      }
    }



    // Cleanup intervals when page is unloaded
    window.addEventListener('beforeunload', () => {
      try {
        // All intervals have been removed to prevent constant API calls
        // if (liveStatusInterval) clearInterval(liveStatusInterval);
        // if (messagesInterval) clearInterval(messagesInterval);
        // if (autoSaveInterval) clearInterval(autoSaveInterval);
      } catch (error) {
        // Silent cleanup
      }
    });

    // Error boundary for unhandled errors
    window.addEventListener('error', (event) => {
      safeLog('error', 'Unhandled error:', event.error);
    });

    window.addEventListener('unhandledrejection', (event) => {
      safeLog('error', 'Unhandled promise rejection:', event.reason);
    });

    // Add event listeners for authentication
    document.addEventListener('DOMContentLoaded', function() {
      // Wait for the unified auth system to be ready
      const waitForAuth = () => {
        if (window.inexAuth && window.inexAuth.isInitialized) {
          // Add auth state listener to update UI
          window.inexAuth.addAuthStateListener(updateAuthUI);
          
          // Add event listener for sign out button
          const signOutBtn = document.getElementById('signOutBtn');
          if (signOutBtn) {
            signOutBtn.addEventListener('click', handleSignOut);
          }
          
          // Show minimal auth gate if needed
          console.log('🔐 Calling ensureTestAuthGate...');
          ensureTestAuthGate();
          
          // Force update UI after initialization
          console.log('🔄 Forcing UI update...');
          updateAuthUI();
          
          console.log('✅ INEX Status Page initialized with unified auth system');
        } else {
          setTimeout(waitForAuth, 100);
        }
      };
      
      waitForAuth();
    });
  </script>
</body>
</html>


